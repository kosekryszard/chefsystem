<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chefsystent - Wydarzenia i Eventy</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
    <style>
        body {
            background: linear-gradient(135deg, #0A1F44 0%, #1a3a6b 100%);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .content { padding: 30px; }
        
        /* Karty event√≥w */
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .event-card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }
        .event-card:hover {
            border-color: #D4AF37;
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
            transform: translateY(-3px);
        }
        .event-card h3 {
            color: #0A1F44;
            margin-bottom: 10px;
        }
        .event-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .event-info-row {
            display: flex;
            gap: 10px;
        }
        .event-info-row strong {
            min-width: 120px;
            color: #0A1F44;
        }
        .event-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }
        .status-roboczy { background: #f0f0f0; color: #666; }
        .status-aktywny { background: #e8f5e9; color: #388e3c; }
        .status-odwolany { background: #ffebee; color: #c62828; }
        .status-archiwum { background: #fff3e0; color: #e65100; }
        
        /* Przyciski akcji */
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .action-btn {
            flex: 0 0 auto;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-plan {
            background: #28a745;
            color: white;
        }
        .btn-plan:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-edit {
            background: #17A2B8;
            color: white;
        }
        .btn-edit:hover { 
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-duplicate {
            background: #6c757d;
            color: white;
        }
        .btn-duplicate:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-status {
            background: #1a3a6b;
            color: white;
            position: relative;
        }
        .btn-status:hover {
            background: #0A1F44;
            transform: translateY(-2px);
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        /* Filtry */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .filter-btn.active {
            background: #D4AF37;
            color: #0A1F44;
            border-color: #D4AF37;
        }
        .filter-btn:hover:not(.active) {
            border-color: #D4AF37;
        }

        /* Menu status√≥w */
        .btn-status {
            position: relative; /* Rodzic musi byƒá relative */
        }
        .status-menu {
            position: absolute;
            bottom: 100%; /* Wy≈õwietl NAD przyciskiem */
            left: 0;
            background: white;
            border: 2px solid #0A1F44;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 180px;
            margin-bottom: 5px;
        }
        .status-menu div {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }
        .status-menu div:last-child {
            border-bottom: none;
        }
        .status-menu div:hover {
            background: #f8f9fa;
            color: #D4AF37;
            font-weight: 600;
        }

        /* Formularz */
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .form-section h3 {
            color: #0A1F44;
            margin-bottom: 15px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #0A1F44;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #D4AF37;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Wydarzenia i Eventy</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Nag≈Ç√≥wek z przyciskiem -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Lista wydarze≈Ñ</h2>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj event</button>
            </div>

            <!-- Filtry -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterEvents('wszystkie')">Wszystkie</button>
                <button class="filter-btn" onclick="filterEvents('roboczy')">Robocze</button>
                <button class="filter-btn" onclick="filterEvents('aktywny')">Aktywne</button>
                <button class="filter-btn" onclick="filterEvents('odwolany')">Odwo≈Çane</button>
                <button class="filter-btn" onclick="filterEvents('archiwum')">Archiwum</button>
            </div>

            <!-- Siatka event√≥w -->
            <div class="events-grid" id="eventsGrid">
                <!-- Karty event√≥w dynamicznie -->
            </div>

            <!-- Spinner -->
            <div id="loader" style="text-align: center; padding: 40px; display: none;">
                <div class="spinner"></div>
                <p>≈Åadowanie wydarze≈Ñ...</p>
            </div>

            <!-- Komunikat o braku event√≥w -->
            <div id="noEvents" style="text-align: center; padding: 40px; color: #666; display: none;">
                <p>Nie znaleziono wydarze≈Ñ. Dodaj pierwszy event!</p>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji eventu -->
    <div class="modal" id="eventModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj event</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <!-- Podstawowe dane -->
                    <div class="form-section">
                        <h3>Podstawowe informacje</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventNazwa">Nazwa eventu *</label>
                                <input type="text" id="eventNazwa" name="nazwa" required>
                            </div>
                            <div class="form-group">
                                <label for="eventTyp">Typ eventu</label>
                                <select id="eventTyp" name="typ">
                                    <option value="event">Event</option>
                                    <option value="catering">Catering</option>
                                    <option value="delivery">Delivery</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventDataStart">Data rozpoczƒôcia *</label>
                                <input type="date" id="eventDataStart" name="data_rozpoczecia" required>
                            </div>
                            <div class="form-group">
                                <label for="eventDataEnd">Data zako≈Ñczenia *</label>
                                <input type="date" id="eventDataEnd" name="data_zakonczenia" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventLokalizacja">Lokalizacja</label>
                                <input type="text" id="eventLokalizacja" name="lokalizacja" placeholder="np. Sala konferencyjna A">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventNotatki">Notatki</label>
                                <textarea id="eventNotatki" name="notatki" rows="3" placeholder="Dodatkowe informacje..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Liczba uczestnik√≥w -->
                    <div class="form-section">
                        <h3>Liczba uczestnik√≥w</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventOsobDoroslych">Doro≈õli</label>
                                <input type="number" id="eventOsobDoroslych" name="liczba_osob_doroslych" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="eventDzieci0_3">Dzieci 0-3 lat</label>
                                <input type="number" id="eventDzieci0_3" name="liczba_dzieci_0_3" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="eventDzieci4_12">Dzieci 4-12 lat</label>
                                <input type="number" id="eventDzieci4_12" name="liczba_dzieci_4_12" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventDzieci12_18">M≈Çodzie≈º 12-18 lat</label>
                                <input type="number" id="eventDzieci12_18" name="liczba_dzieci_12_18" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label for="eventOsob18Plus">Osoby 18+ (specjalna dieta)</label>
                                <input type="number" id="eventOsob18Plus" name="liczba_osob_18_plus" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <!-- Przyciski -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-primary" id="saveBtn">Zapisz event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ZMIENNE GLOBALNE
        // ============================================
        let allEvents = [];
        let currentFilter = 'wszystkie';
        let editingEventId = null;

        // ============================================
        // INICJALIZACJA
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            loadEvents();
        });

        // ============================================
        // ≈ÅADOWANIE EVENT√ìW
        // ============================================
        async function loadEvents() {
            showLoader();
            
            try {
                const response = await fetch('/api/events');
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania event√≥w');
                
                allEvents = await response.json();
                renderEvents();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd ≈Çadowania event√≥w: ' + error.message);
            } finally {
                hideLoader();
            }
        }

        // ============================================
        // RENDEROWANIE EVENT√ìW
        // ============================================
        function renderEvents() {
            const grid = document.getElementById('eventsGrid');
            const noEventsMsg = document.getElementById('noEvents');
            
            // Filtruj eventy
            let filteredEvents = allEvents;
            if (currentFilter !== 'wszystkie') {
                filteredEvents = allEvents.filter(e => e.status === currentFilter);
            }
            
            // Sortuj po dacie rozpoczƒôcia (najbli≈ºsze na g√≥rze)
            filteredEvents.sort((a, b) => new Date(a.data_rozpoczecia) - new Date(b.data_rozpoczecia));
            
            // Wy≈õwietl komunikat je≈õli brak
            if (filteredEvents.length === 0) {
                grid.style.display = 'none';
                noEventsMsg.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            noEventsMsg.style.display = 'none';
            
            // Generuj karty
            grid.innerHTML = filteredEvents.map(event => `
                <div class="event-card">
                    <h3>${event.nazwa}</h3>
                    <div class="event-info">
                        <div class="event-info-row">
                            <strong>Typ:</strong>
                            <span>${getEventTypeName(event.typ)}</span>
                        </div>
                        <div class="event-info-row">
                            <strong>Termin:</strong>
                            <span>${formatDate(event.data_rozpoczecia)} - ${formatDate(event.data_zakonczenia)}</span>
                        </div>
                        <div class="event-info-row">
                            <strong>Liczba os√≥b:</strong>
                            <span>${getTotalPeople(event)}</span>
                        </div>
                        ${event.lokalizacja ? `
                        <div class="event-info-row">
                            <strong>Lokalizacja:</strong>
                            <span>${event.lokalizacja}</span>
                        </div>
                        ` : ''}
                    </div>
                    <span class="event-status status-${event.status}">${getStatusName(event.status)}</span>
                    
                    <div class="action-buttons">
                        <button class="action-btn btn-plan" onclick="planEvent(${event.id})" title="Planuj">
                            üìÖ Planuj
                        </button>
                        <button class="action-btn btn-edit" onclick="editEvent(${event.id})" title="Edytuj">
                            ‚úèÔ∏è
                        </button>
                        <button class="action-btn btn-duplicate" onclick="duplicateEvent(${event.id})" title="Duplikuj">
                            üìã
                        </button>
                        <button class="action-btn btn-status" onclick="toggleStatusMenu(event, ${event.id})" title="Zmie≈Ñ status">
                            üì¶
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteEvent(${event.id})" title="Usu≈Ñ">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // FUNKCJE POMOCNICZE - FORMATOWANIE
        // ============================================
        function getEventTypeName(typ) {
            const types = {
                'event': 'Wydarzenie',
                'catering': 'Catering',
                'delivery': 'Dostawa'
            };
            return types[typ] || typ;
        }

        function getStatusName(status) {
            const statuses = {
                'roboczy': 'Roboczy',
                'aktywny': 'Aktywny',
                'odwolany': 'Odwo≈Çany',
                'archiwum': 'Archiwum'
            };
            return statuses[status] || status;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function getTotalPeople(event) {
            const total = (event.liczba_osob_doroslych || 0) +
                         (event.liczba_dzieci_0_3 || 0) +
                         (event.liczba_dzieci_4_12 || 0) +
                         (event.liczba_dzieci_12_18 || 0) +
                         (event.liczba_osob_18_plus || 0);
            return total;
        }

        // ============================================
        // FILTROWANIE
        // ============================================
        function filterEvents(status) {
            currentFilter = status;
            
            // Aktualizuj przyciski
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderEvents();
        }

        // ============================================
        // MODAL - OTWIERANIE/ZAMYKANIE
        // ============================================
        function openAddModal() {
            editingEventId = null;
            document.getElementById('modalTitle').textContent = 'Dodaj event';
            document.getElementById('eventForm').reset();
            document.getElementById('eventModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
            editingEventId = null;
        }

        // ============================================
        // ZAPISYWANIE EVENTU
        // ============================================
        async function saveEvent(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Konwersja liczb
            ['liczba_osob_doroslych', 'liczba_dzieci_0_3', 'liczba_dzieci_4_12', 
             'liczba_dzieci_12_18', 'liczba_osob_18_plus'].forEach(field => {
                data[field] = parseInt(data[field]) || 0;
            });
            
            // Dodaj status
            if (!editingEventId) {
                data.status = 'roboczy';
            }
            
            try {
                const url = editingEventId 
                    ? `/api/events/${editingEventId}` 
                    : '/api/events';
                const method = editingEventId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                closeModal();
                loadEvents();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd zapisu eventu: ' + error.message);
            }
        }

        // ============================================
        // EDYCJA EVENTU
        // ============================================
        async function editEvent(id) {
            try {
                const response = await fetch(`/api/events/${id}`);
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania eventu');
                
                const event = await response.json();
                editingEventId = id;
                
                // Wype≈Çnij formularz
                document.getElementById('modalTitle').textContent = 'Edytuj event';
                document.getElementById('eventNazwa').value = event.nazwa || '';
                document.getElementById('eventTyp').value = event.typ || 'event';
                document.getElementById('eventDataStart').value = event.data_rozpoczecia || '';
                document.getElementById('eventDataEnd').value = event.data_zakonczenia || '';
                document.getElementById('eventLokalizacja').value = event.lokalizacja || '';
                document.getElementById('eventNotatki').value = event.notatki || '';
                document.getElementById('eventOsobDoroslych').value = event.liczba_osob_doroslych || 0;
                document.getElementById('eventDzieci0_3').value = event.liczba_dzieci_0_3 || 0;
                document.getElementById('eventDzieci4_12').value = event.liczba_dzieci_4_12 || 0;
                document.getElementById('eventDzieci12_18').value = event.liczba_dzieci_12_18 || 0;
                document.getElementById('eventOsob18Plus').value = event.liczba_osob_18_plus || 0;
                
                document.getElementById('eventModal').style.display = 'flex';
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd ≈Çadowania eventu: ' + error.message);
            }
        }

        // ============================================
        // USUWANIE EVENTU
        // ============================================
        async function deleteEvent(id) {
            const event = allEvents.find(e => e.id === id);
            if (!event) return;
            
            if (!confirm(`Czy na pewno usunƒÖƒá event "${event.nazwa}"?\n\nTa operacja jest nieodwracalna i usunie wszystkie powiƒÖzane dni, sekcje i zadania!`)) {
                return;
            }
            
            if (!confirm('OSTATECZNE POTWIERDZENIE\n\nNaprawdƒô usunƒÖƒá ten event? To nie mo≈ºe byƒá cofniƒôte!')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/events/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                loadEvents();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd usuwania eventu: ' + error.message);
            }
        }

        // ============================================
        // DUPLIKACJA EVENTU
        // ============================================
        async function duplicateEvent(id) {
            if (!confirm('Czy utworzyƒá kopiƒô tego eventu?')) return;
            
            try {
                const response = await fetch(`/api/events/${id}/duplicate`, {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikacji');
                
                loadEvents();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd duplikacji eventu: ' + error.message);
            }
        }

        // ============================================
        // MENU STATUS√ìW
        // ============================================
        function toggleStatusMenu(e, eventId) {
            e.stopPropagation();
            
            // Usu≈Ñ istniejƒÖce menu
            document.querySelectorAll('.status-menu').forEach(m => m.remove());
            
            // Utw√≥rz nowe menu
            const menu = document.createElement('div');
            menu.className = 'status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${eventId}, 'roboczy')">üìù Roboczy</div>
                <div onclick="changeStatus(${eventId}, 'aktywny')">‚úÖ Aktywny</div>
                <div onclick="changeStatus(${eventId}, 'odwolany')">‚ùå Odwo≈Çany</div>
                <div onclick="changeStatus(${eventId}, 'archiwum')">üì¶ Archiwum</div>
            `;
            
            // Pozycjonowanie menu (pozycjƒô ustala CSS)
            const btn = e.target.closest('.btn-status');
            btn.appendChild(menu);
            
            // Zamknij menu po klikniƒôciu poza
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        async function changeStatus(eventId, newStatus) {
            try {
                const response = await fetch(`/api/events/${eventId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                loadEvents();
            } catch (error) {
                console.error('B≈ÇƒÖd:', error);
                alert('B≈ÇƒÖd zmiany statusu: ' + error.message);
            }
        }

        // ============================================
        // PRZEKIEROWANIE DO PLANNERA
        // ============================================
        function planEvent(id) {
            window.location.href = `event-planning.html?id=${id}`;
        }

        // ============================================
        // LOADER
        // ============================================
        function showLoader() {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('eventsGrid').style.display = 'none';
            document.getElementById('noEvents').style.display = 'none';
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Zamknij modal po klikniƒôciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>
</body>
</html>
