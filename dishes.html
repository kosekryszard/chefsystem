<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Dania</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Dania</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html" class="active">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry status√≥w -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterDishes('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="draft" onclick="filterDishes('draft')">
                    üìù Robocze
                </button>
                <button class="filter-btn" data-filter="active" onclick="filterDishes('active')">
                    ‚úÖ Aktywne
                </button>
                <button class="filter-btn" data-filter="archived" onclick="filterDishes('archived')">
                    üì¶ Archiwum
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Lista da≈Ñ</h2>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj danie</button>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj danie..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid da≈Ñ -->
            <div class="items-grid" id="dishesGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie da≈Ñ...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji (zachowany z obecnej wersji - uproszczony) -->
    <div id="dishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj danie</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="dishForm" onsubmit="saveDish(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="form-group">
                        <label>Nazwa *</label>
                        <input type="text" id="nazwa" required>
                    </div>

                    <div class="form-group">
                        <label>Nazwa dla karty</label>
                        <input type="text" id="nazwa_karta">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Typ</label>
                            <input type="text" id="typ" placeholder="Danie g≈Ç√≥wne, Przystawka">
                        </div>
                        <div class="form-group">
                            <label>Cena sugerowana (PLN)</label>
                            <input type="number" step="0.01" id="cena_sugerowana">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Wydajno≈õƒá (liczba)</label>
                            <input type="number" step="0.01" id="wydajnosc_ilosc">
                        </div>
                        <div class="form-group">
                            <label>Jednostka wydajno≈õci</label>
                            <input type="text" id="wydajnosc_jm" placeholder="porcja" value="porcja">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Opis dla karty</label>
                        <textarea id="opis_karta" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="wegetarianski">
                                Wegetaria≈Ñskie
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="weganski">
                                Wega≈Ñskie
                            </label>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-success">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allDishes = [];
        let filteredDishes = [];
        let currentFilter = 'all';

        // ≈Åadowanie danych
        window.addEventListener('DOMContentLoaded', () => {
            loadDishes();
        });

        async function loadDishes() {
            try {
                const response = await fetch(`${API_URL}/api/dishes`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allDishes = await response.json();
                filteredDishes = [...allDishes];
                
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dishesGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        // Filtry
        function filterDishes(filter) {
            currentFilter = filter;
            
            // Aktywuj przycisk
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredDishes = allDishes.filter(dish => {
                // Search
                const matchesSearch = dish.nazwa.toLowerCase().includes(searchTerm) ||
                    (dish.nazwa_karta && dish.nazwa_karta.toLowerCase().includes(searchTerm));
                
                // Status filter
                let matchesStatus = true;
                if (currentFilter !== 'all') {
                    matchesStatus = dish.status === currentFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            renderGrid();
        }

        // Renderowanie grid
        function renderGrid() {
            const grid = document.getElementById('dishesGrid');
            
            if (filteredDishes.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredDishes.map(dish => {
                // Status badge
                const statusBadges = {
                    'draft': '<span class="badge badge-status-draft">üìù Robocze</span>',
                    'active': '<span class="badge badge-status-active">‚úÖ Aktywne</span>',
                    'archived': '<span class="badge badge-status-archived">üì¶ Archiwum</span>'
                };
                const statusBadge = statusBadges[dish.status] || '';
                
                // In use badge
                const inUseBadge = dish.in_use ? '<span class="item-card-badge">üîí W u≈ºyciu</span>' : '';
                
                // Diet badges
                const dietBadges = [];
                if (dish.weganski) dietBadges.push('<span class="badge badge-vegan">üå± Vegan</span>');
                if (dish.wegetarianski) dietBadges.push('<span class="badge badge-vegetarian">ü•¨ Wege</span>');
                
                return `
                    <div class="item-card" data-id="${dish.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewDish(${dish.id})">
                            <h3 class="item-card-title">${dish.nazwa}</h3>
                            ${inUseBadge}
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Opis -->
                            ${dish.opis_karta ? `<p class="item-card-description">${dish.opis_karta}</p>` : ''}
                            
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                ${dish.typ ? `<span class="badge badge-type">${dish.typ}</span>` : ''}
                                ${dish.cena_sugerowana ? `<span class="badge badge-price">${dish.cena_sugerowana} PLN</span>` : ''}
                                ${dish.wydajnosc_ilosc ? `<span class="badge badge-yield">${dish.wydajnosc_ilosc} ${dish.wydajnosc_jm || 'porcji'}</span>` : ''}
                                ${statusBadge}
                                ${dietBadges.join('')}
                            </div>
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editDish(${dish.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateDish(${dish.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-status" onclick="showStatusMenu(event, ${dish.id})">
                                    üìä Status
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteDish(${dish.id})" ${dish.in_use ? 'disabled title="Nie mo≈ºna usunƒÖƒá - danie jest w u≈ºyciu"' : ''}>
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FLOATING STATUS MENU === 
        function showStatusMenu(event, dishId) {
            event.stopPropagation();
            
            const existing = document.getElementById('floatingStatusMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'floatingStatusMenu';
            menu.className = 'floating-status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${dishId}, 'draft')">üìù Robocze</div>
                <div onclick="changeStatus(${dishId}, 'active')">‚úÖ Aktywne</div>
                <div onclick="changeStatus(${dishId}, 'archived')">üì¶ Archiwum</div>
            `;
            
            document.body.appendChild(menu);
            
            const buttonRect = event.target.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            let top, left;
            
            if (buttonRect.bottom + menuRect.height + 10 < viewportHeight) {
                top = buttonRect.bottom + 5;
            } else {
                top = buttonRect.top - menuRect.height - 5;
            }
            
            if (buttonRect.left + menuRect.width > viewportWidth) {
                left = buttonRect.right - menuRect.width;
            } else {
                left = buttonRect.left;
            }
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        // Zmie≈Ñ status
        async function changeStatus(dishId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/dishes/${dishId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                document.getElementById('floatingStatusMenu')?.remove();
                loadDishes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zmiany statusu');
            }
        }

        // PodglƒÖd dania (nowa strona)
        function viewDish(dishId) {
            window.location.href = `dishes-view.html?id=${dishId}`;
        }

        // === CRUD OPERATIONS ===
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj danie';
            document.getElementById('dishForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('dishModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dishModal').style.display = 'none';
        }

        async function editDish(id) {
            const dish = allDishes.find(d => d.id === id);
            if (!dish) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj danie';
            document.getElementById('editId').value = dish.id;
            document.getElementById('nazwa').value = dish.nazwa || '';
            document.getElementById('nazwa_karta').value = dish.nazwa_karta || '';
            document.getElementById('typ').value = dish.typ || '';
            document.getElementById('cena_sugerowana').value = dish.cena_sugerowana || '';
            document.getElementById('wydajnosc_ilosc').value = dish.wydajnosc_ilosc || '';
            document.getElementById('wydajnosc_jm').value = dish.wydajnosc_jm || 'porcja';
            document.getElementById('opis_karta').value = dish.opis_karta || '';
            document.getElementById('wegetarianski').checked = dish.wegetarianski || false;
            document.getElementById('weganski').checked = dish.weganski || false;
            
            document.getElementById('dishModal').style.display = 'block';
        }

        async function saveDish(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
                nazwa: document.getElementById('nazwa').value,
                nazwa_karta: document.getElementById('nazwa_karta').value,
                typ: document.getElementById('typ').value,
                cena_sugerowana: parseFloat(document.getElementById('cena_sugerowana').value) || null,
                wydajnosc_ilosc: parseFloat(document.getElementById('wydajnosc_ilosc').value) || null,
                wydajnosc_jm: document.getElementById('wydajnosc_jm').value || 'porcja',
                opis_karta: document.getElementById('opis_karta').value,
                wegetarianski: document.getElementById('wegetarianski').checked,
                weganski: document.getElementById('weganski').checked
            };
            
            try {
                const url = id ? `${API_URL}/api/dishes/${id}` : `${API_URL}/api/dishes`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                alert(id ? 'Zapisano zmiany' : 'Dodano danie');
                closeModal();
                loadDishes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        async function duplicateDish(id) {
            const dish = allDishes.find(d => d.id === id);
            if (!dish) return;
            
            if (!confirm(`Duplikowaƒá danie "${dish.nazwa}"?`)) return;
            
            const newDish = {
                nazwa: dish.nazwa + ' (kopia)',
                nazwa_karta: dish.nazwa_karta,
                typ: dish.typ,
                cena_sugerowana: dish.cena_sugerowana,
                wydajnosc_ilosc: dish.wydajnosc_ilosc,
                wydajnosc_jm: dish.wydajnosc_jm,
                opis_karta: dish.opis_karta,
                wegetarianski: dish.wegetarianski,
                weganski: dish.weganski,
                status: 'draft'
            };
            
            try {
                const response = await fetch(`${API_URL}/api/dishes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newDish)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
                
                alert('Zduplikowano danie (bez komponent√≥w - dodaj je rƒôcznie)');
                loadDishes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd duplikowania: ' + error.message);
            }
        }

        async function deleteDish(id) {
            const dish = allDishes.find(d => d.id === id);
            if (!dish) return;
            
            if (dish.in_use) {
                alert('Nie mo≈ºna usunƒÖƒá dania kt√≥re jest w u≈ºyciu');
                return;
            }
            
            if (!confirm(`Czy na pewno usunƒÖƒá "${dish.nazwa}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/dishes/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                alert('Usuniƒôto danie');
                loadDishes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd usuwania: ' + error.message);
            }
        }

        // Zamykanie modala klikniƒôciem poza
        window.onclick = function(event) {
            const modal = document.getElementById('dishModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
