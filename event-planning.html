<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chefsystent - Planowanie Eventu</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
    <style>
        body {
            background: linear-gradient(135deg, #0A1F44 0%, #1a3a6b 100%);
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .content { padding: 30px; }
        
        /* Info eventu */
        .event-info-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .info-item label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        .info-item .value {
            font-size: 16px;
            color: #0A1F44;
            font-weight: 700;
        }
        
        /* Sticky actions */
        .sticky-actions {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 0;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            z-index: 100;
            border-bottom: 2px solid #e0e0e0;
        }
        
        /* Dzie≈Ñ "Produkcja" */
        .production-day {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .production-day h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        /* Timeline dni */
        .days-timeline {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* Karta dnia */
        .day-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .day-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0A1F44 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Split view: Sekcje | Zadania */
        .day-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            background: #e0e0e0;
        }
        
        .day-split-left,
        .day-split-right {
            background: white;
            padding: 20px;
            min-height: 200px;
        }
        
        .split-title {
            font-size: 16px;
            font-weight: 700;
            color: #0A1F44;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #D4AF37;
        }
        
        /* Sekcje */
        .section-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #0A1F44;
        }
        
        .section-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Dania w sekcji */
        .dishes-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }
        
        .dish-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dish-name {
            font-weight: 600;
            color: #0A1F44;
        }
        
        .dish-portions {
            color: #666;
            font-size: 13px;
        }
        
        /* Zadania */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .task-item.from-recipe {
            background: #e7f3ff;
            border-color: #b3d9ff;
        }
        
        .task-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 2px;
        }
        
        .task-text {
            flex: 1;
            font-size: 14px;
        }
        
        .task-text.completed {
            text-decoration: line-through;
            color: #999;
        }
        
        .task-date {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }
        
        /* Przyciski */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #D4AF37;
            color: #0A1F44;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0A1F44 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .close {
            font-size: 28px;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #0A1F44;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Lista da≈Ñ w modalu */
        .dishes-modal-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .dish-modal-item {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dish-modal-item:hover {
            border-color: #D4AF37;
            background: #fffef7;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Planowanie Eventu</p>
            
            <nav>
                <a href="index.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">‚Üê Eventy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Loading -->
            <div id="loadingState" style="text-align: center; padding: 40px;">
                ≈Åadowanie danych eventu...
            </div>

            <!-- Main content -->
            <div id="mainContent" style="display: none;">
                
                <!-- Info eventu -->
                <div class="event-info-header">
                    <div class="info-item">
                        <label>Nazwa eventu</label>
                        <div class="value" id="eventName">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Typ</label>
                        <div class="value" id="eventType">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Lokalizacja</label>
                        <div class="value" id="eventLocation">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Liczba os√≥b</label>
                        <div class="value" id="eventPeople">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Okres</label>
                        <div class="value" id="eventPeriod">‚Äî</div>
                    </div>
                </div>

                <!-- Sticky actions -->
                <div class="sticky-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='events.html'">
                        ‚Üê Wr√≥ƒá do event√≥w
                    </button>
                    <h2 style="margin: 0; flex: 1;">Plan eventu</h2>
                    
                    <!-- Eksport PDF -->
                    <div style="position: relative;">
                        <button class="btn btn-primary" onclick="togglePdfMenu()">
                            üìÑ Generuj PDF
                        </button>
                        <div id="pdfMenu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: white; border: 2px solid #D4AF37; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000;">
                            <button onclick="generatePDF('menu')" style="width: 100%; text-align: left; padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600;">
                                üìã Jad≈Çospis
                            </button>
                            <button onclick="generatePDF('tasks')" style="width: 100%; text-align: left; padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600;">
                                ‚úÖ Zadania
                            </button>
                            <button onclick="generatePDF('complete')" style="width: 100%; text-align: left; padding: 12px 20px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 600;">
                                üì¶ Kompletny
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dzie≈Ñ "Produkcja" -->
                <div class="production-day" id="productionDay">
                    <h3>üì¶ Produkcja (przygotowanie przed eventem)</h3>
                    <div id="productionTasks" class="tasks-list">
                        <!-- Zadania produkcyjne -->
                    </div>
                    <button class="btn btn-primary btn-small" onclick="openAddTaskModal('production')" style="margin-top: 10px;">
                        ‚ûï Dodaj zadanie
                    </button>
                </div>

                <!-- Timeline dni -->
                <div class="days-timeline" id="daysTimeline">
                    <!-- Dni generowane przez JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Dodaj sekcjƒô -->
    <div id="sectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dodaj sekcjƒô</h2>
                <span class="close" onclick="closeSectionModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <form id="sectionForm" onsubmit="saveSection(event)">
                    <input type="hidden" id="sectionDayId">
                    
                    <div class="form-group">
                        <label>Nazwa sekcji *</label>
                        <select id="sectionNazwa" onchange="toggleCustomName()">
                            <option value="≈öniadanie">≈öniadanie</option>
                            <option value="Ciep≈Çy posi≈Çek">Ciep≈Çy posi≈Çek</option>
                            <option value="Zimna p≈Çyta">Zimna p≈Çyta</option>
                            <option value="custom">W≈Çasna nazwa...</option>
                        </select>
                        <input type="text" id="sectionNazwaCustom" style="margin-top: 10px; display: none;" placeholder="Wpisz nazwƒô">
                    </div>
                    
                    <div class="form-group">
                        <label>Godzina rozpoczƒôcia</label>
                        <input type="time" id="sectionGodzinaStart">
                    </div>
                    
                    <div class="form-group">
                        <label>Godzina zako≈Ñczenia</label>
                        <input type="time" id="sectionGodzinaKoniec">
                    </div>
                    
                    <div class="form-group">
                        <label>Rodzaj serwisu</label>
                        <select id="sectionSerwis">
                            <option value="">‚Äî</option>
                            <option value="Talerzowo">Talerzowo</option>
                            <option value="Bemar">Bemar</option>
                            <option value="P√≥≈Çmiskowo">P√≥≈Çmiskowo</option>
                            <option value="Bufet">Bufet</option>
                            <option value="Thermoboxy">Thermoboxy</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Liczba porcji</label>
                        <input type="number" id="sectionPorcje" min="0">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">Zapisz</button>
                        <button type="button" class="btn btn-secondary" onclick="closeSectionModal()">Anuluj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Dodaj danie -->
    <div id="dishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dodaj danie do sekcji</h2>
                <span class="close" onclick="closeDishModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="dishSectionId">
                
                <input type="text" id="dishSearch" placeholder="üîç Szukaj dania..." 
                       style="width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0; border-radius: 8px;"
                       onkeyup="filterDishes()">
                
                <div id="dishesList" class="dishes-modal-list">
                    <!-- Lista da≈Ñ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Dodaj zadanie -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Dodaj zadanie</h2>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <input type="hidden" id="taskDayId">
                    <input type="hidden" id="taskType">
                    
                    <div class="form-group">
                        <label>Opis zadania *</label>
                        <textarea id="taskNazwa" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-group" id="taskDateGroup" style="display: none;">
                        <label>Data wykonania (opcjonalnie, dla produkcji)</label>
                        <input type="date" id="taskDataWykonania">
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">Zapisz</button>
                        <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Anuluj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Przenie≈õ zadanie -->
    <div id="moveTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Przenie≈õ zadanie do innego dnia</h2>
                <span class="close" onclick="closeMoveTaskModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="moveTaskId">
                <p id="moveTaskInfo" style="margin-bottom: 15px; font-weight: 600;"></p>
                
                <div id="moveDaysList" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Lista dni -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ZMIENNE GLOBALNE ==========
        let eventId = null;
        let eventData = null;
        let eventDays = [];
        let allDishes = [];
        let sectionsData = [];
        let tasksData = [];
        let productionDayId = null;

        // ========== INICJALIZACJA ==========
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('id');
            
            if (!eventId) {
                alert('‚ùå Brak ID eventu!');
                window.location.href = 'events.html';
                return;
            }
            
            await loadEventData();
            await loadDishes();
            await loadOrCreateDays();
            await loadSectionsAndDishes();
            await loadTasks();
            renderTimeline();
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        });

        // ========== ≈ÅADOWANIE DANYCH ==========
        
        async function loadEventData() {
            try {
                const response = await fetch(`/api/events/${eventId}`);
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania eventu');
                
                eventData = await response.json();
                
                document.getElementById('eventName').textContent = eventData.nazwa;
                document.getElementById('eventType').textContent = getEventTypeName(eventData.typ);
                document.getElementById('eventLocation').textContent = eventData.lokalizacja || '‚Äî';
                
                const totalPeople = (eventData.liczba_osob_doroslych || 0) +
                                   (eventData.liczba_dzieci_0_3 || 0) +
                                   (eventData.liczba_dzieci_4_12 || 0) +
                                   (eventData.liczba_dzieci_12_18 || 0) +
                                   (eventData.liczba_osob_18_plus || 0);
                document.getElementById('eventPeople').textContent = totalPeople ? `${totalPeople} os√≥b` : '‚Äî';
                
                const dateStart = new Date(eventData.data_rozpoczecia).toLocaleDateString('pl-PL');
                const dateEnd = new Date(eventData.data_zakonczenia).toLocaleDateString('pl-PL');
                document.getElementById('eventPeriod').textContent = `${dateStart} ‚Äì ${dateEnd}`;
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd ≈Çadowania eventu');
            }
        }

        async function loadDishes() {
            try {
                const response = await fetch('/api/dishes');
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania da≈Ñ');
                
                allDishes = await response.json();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadOrCreateDays() {
            try {
                const response = await fetch(`/api/events/${eventId}/days`);
                eventDays = await response.json();
                
                // Je≈õli brak dni - utw√≥rz je
                if (eventDays.length === 0) {
                    await createEventDays();
                    const response2 = await fetch(`/api/events/${eventId}/days`);
                    eventDays = await response2.json();
                }
                
                // Znajd≈∫ dzie≈Ñ "Produkcja"
                const prodDay = eventDays.find(d => d.kolejnosc === -1);
                if (prodDay) {
                    productionDayId = prodDay.id;
                }
                
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function createEventDays() {
            const startDate = new Date(eventData.data_rozpoczecia);
            const endDate = new Date(eventData.data_zakonczenia);
            
            // Dzie≈Ñ "Produkcja"
            await fetch(`/api/events/${eventId}/days`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data: null,
                    nazwa: 'Produkcja',
                    kolejnosc: -1
                })
            });
            
            // Dni eventu
            let currentDate = new Date(startDate);
            let dayNum = 0;
            
            while (currentDate <= endDate) {
                const dayName = currentDate.toLocaleDateString('pl-PL', { weekday: 'long' });
                const dateStr = currentDate.toLocaleDateString('pl-PL');
                
                await fetch(`/api/events/${eventId}/days`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: currentDate.toISOString().split('T')[0],
                        nazwa: `${dayName}, ${dateStr}`,
                        kolejnosc: dayNum
                    })
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
                dayNum++;
            }
        }

        async function loadSectionsAndDishes() {
            try {
                const response = await fetch(`/api/events/${eventId}/sections`);
                sectionsData = await response.json();
                
                // Dla ka≈ºdej sekcji pobierz dania
                for (const section of sectionsData) {
                    const dishesResp = await fetch(`/api/event-sections/${section.id}/dishes`);
                    section.dishes = await dishesResp.json();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadTasks() {
            try {
                tasksData = [];
                for (const day of eventDays) {
                    const response = await fetch(`/api/event-days/${day.id}/tasks`);
                    const dayTasks = await response.json();
                    tasksData.push(...dayTasks.map(t => ({...t, day_id: day.id})));
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ========== RENDEROWANIE ==========
        
        function renderTimeline() {
            renderProductionTasks();
            renderEventDays();
        }

        function renderProductionTasks() {
            const container = document.getElementById('productionTasks');
            const prodTasks = tasksData.filter(t => t.event_day_id === productionDayId);
            
            // Sortuj po dacie wykonania
            prodTasks.sort((a, b) => {
                if (!a.data_wykonania && !b.data_wykonania) return 0;
                if (!a.data_wykonania) return 1;
                if (!b.data_wykonania) return -1;
                return new Date(a.data_wykonania) - new Date(b.data_wykonania);
            });
            
            if (prodTasks.length === 0) {
                container.innerHTML = '<p style="color: #666; font-size: 14px;">Brak zada≈Ñ produkcyjnych</p>';
                return;
            }
            
            container.innerHTML = prodTasks.map(task => `
                <div class="task-item ${task.source_type === 'recipe' ? 'from-recipe' : ''}">
                    <input type="checkbox" class="task-checkbox" 
                           ${task.zrobione ? 'checked' : ''} 
                           onchange="toggleTask(${task.id}, this.checked)">
                    <div style="flex: 1;">
                        <div class="task-text ${task.zrobione ? 'completed' : ''}">${task.nazwa}</div>
                        ${task.data_wykonania ? `<div class="task-date">üìÖ ${new Date(task.data_wykonania).toLocaleDateString('pl-PL')}</div>` : ''}
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="openMoveTaskModal(${task.id})" title="Przenie≈õ">
                        ‚ÜîÔ∏è
                    </button>
                    ${task.source_type === 'custom' ? `
                        <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderEventDays() {
            const timeline = document.getElementById('daysTimeline');
            const regularDays = eventDays.filter(d => d.kolejnosc >= 0).sort((a, b) => a.kolejnosc - b.kolejnosc);
            
            timeline.innerHTML = regularDays.map(day => createDayCard(day)).join('');
        }

        function createDayCard(day) {
            const daySections = sectionsData.filter(s => s.event_day_id === day.id);
            const dayTasks = tasksData.filter(t => t.event_day_id === day.id);
            
            return `
                <div class="day-card">
                    <div class="day-header">
                        <h3>Dzie≈Ñ ${day.kolejnosc + 1} - ${day.nazwa}</h3>
                        <button class="btn btn-primary" onclick="openAddSectionModal(${day.id})">
                            ‚ûï Dodaj sekcjƒô
                        </button>
                    </div>
                    <div class="day-split">
                        <div class="day-split-left">
                            <div class="split-title">Sekcje i dania</div>
                            ${daySections.length === 0 ? '<p style="color: #999;">Brak sekcji</p>' : ''}
                            ${daySections.map(section => createSectionCard(section)).join('')}
                        </div>
                        <div class="day-split-right">
                            <div class="split-title">Zadania</div>
                            ${dayTasks.length === 0 ? '<p style="color: #999;">Brak zada≈Ñ</p>' : ''}
                            <div class="tasks-list">
                                ${dayTasks.map(task => createTaskItem(task)).join('')}
                            </div>
                            <button class="btn btn-primary btn-small" onclick="openAddTaskModal(${day.id})" style="margin-top: 10px;">
                                ‚ûï Dodaj zadanie
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createSectionCard(section) {
            const dishes = section.dishes || [];
            const timeRange = section.godzina_start || section.godzina_koniec ? 
                `${section.godzina_start || '‚Äî'} - ${section.godzina_koniec || '‚Äî'}` : '';
            
            return `
                <div class="section-card">
                    <div class="section-header">
                        <div>
                            <div class="section-title">${section.nazwa}</div>
                            ${timeRange || section.rodzaj_serwisu || section.liczba_porcji ? 
                                `<div class="section-meta">
                                    ${timeRange ? `üïê ${timeRange}` : ''}
                                    ${section.rodzaj_serwisu ? `„Éª${section.rodzaj_serwisu}` : ''}
                                    ${section.liczba_porcji ? `„Éª${section.liczba_porcji} porcji` : ''}
                                </div>` : ''
                            }
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-primary btn-small" onclick="openAddDishModal(${section.id})">
                                ‚ûï Danie
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteSection(${section.id})">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="dishes-list">
                        ${dishes.length === 0 ? '<p style="color: #999; font-size: 12px;">Brak da≈Ñ</p>' : ''}
                        ${dishes.map(dish => `
                            <div class="dish-item">
                                <div>
                                    <div class="dish-name">${dish.dishes.nazwa}</div>
                                    <div class="dish-portions">${dish.liczba_porcji} porcji</div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteDish(${dish.id})">
                                    üóëÔ∏è
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createTaskItem(task) {
            return `
                <div class="task-item ${task.source_type === 'recipe' ? 'from-recipe' : ''}">
                    <input type="checkbox" class="task-checkbox" 
                           ${task.zrobione ? 'checked' : ''} 
                           onchange="toggleTask(${task.id}, this.checked)">
                    <div style="flex: 1;">
                        <div class="task-text ${task.zrobione ? 'completed' : ''}">${task.nazwa}</div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="openMoveTaskModal(${task.id})" title="Przenie≈õ">
                        ‚ÜîÔ∏è
                    </button>
                    ${task.source_type === 'custom' ? `
                        <button class="btn btn-danger btn-small" onclick="deleteTask(${task.id})">
                            üóëÔ∏è
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // ========== MODALS - SEKCJA ==========
        
        function openAddSectionModal(dayId) {
            document.getElementById('sectionForm').reset();
            document.getElementById('sectionDayId').value = dayId;
            document.getElementById('sectionNazwaCustom').style.display = 'none';
            document.getElementById('sectionModal').style.display = 'flex';
        }

        function closeSectionModal() {
            document.getElementById('sectionModal').style.display = 'none';
        }

        function toggleCustomName() {
            const select = document.getElementById('sectionNazwa');
            const customInput = document.getElementById('sectionNazwaCustom');
            customInput.style.display = select.value === 'custom' ? 'block' : 'none';
        }

        async function saveSection(e) {
            e.preventDefault();
            
            const dayId = document.getElementById('sectionDayId').value;
            const nazwaSelect = document.getElementById('sectionNazwa').value;
            const nazwaCustom = document.getElementById('sectionNazwaCustom').value;
            
            const data = {
                nazwa: nazwaSelect === 'custom' ? nazwaCustom : nazwaSelect,
                godzina_start: document.getElementById('sectionGodzinaStart').value || null,
                godzina_koniec: document.getElementById('sectionGodzinaKoniec').value || null,
                rodzaj_serwisu: document.getElementById('sectionSerwis').value || null,
                liczba_porcji: parseInt(document.getElementById('sectionPorcje').value) || null,
                kolejnosc: 1
            };
            
            try {
                const response = await fetch(`/api/event-days/${dayId}/sections`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                await loadSectionsAndDishes();
                renderTimeline();
                closeSectionModal();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd zapisu sekcji');
            }
        }

        async function deleteSection(id) {
            if (!confirm('UsunƒÖƒá sekcjƒô wraz z daniami?')) return;
            
            try {
                const response = await fetch(`/api/event-sections/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                await loadSectionsAndDishes();
                await loadTasks();
                renderTimeline();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd usuwania sekcji');
            }
        }

        // ========== MODALS - DANIE ==========
        
        function openAddDishModal(sectionId) {
            document.getElementById('dishSectionId').value = sectionId;
            document.getElementById('dishSearch').value = '';
            renderDishesList();
            document.getElementById('dishModal').style.display = 'flex';
        }

        function closeDishModal() {
            document.getElementById('dishModal').style.display = 'none';
        }

        function renderDishesList() {
            const list = document.getElementById('dishesList');
            list.innerHTML = allDishes.map(dish => `
                <div class="dish-modal-item" onclick="selectDish(${dish.id})">
                    <div style="font-weight: 600;">${dish.nazwa}</div>
                    <div style="font-size: 12px; color: #666;">${dish.typ || '‚Äî'}</div>
                </div>
            `).join('');
        }

        function filterDishes() {
            const search = document.getElementById('dishSearch').value.toLowerCase();
            const filtered = allDishes.filter(d => d.nazwa.toLowerCase().includes(search));
            
            const list = document.getElementById('dishesList');
            list.innerHTML = filtered.map(dish => `
                <div class="dish-modal-item" onclick="selectDish(${dish.id})">
                    <div style="font-weight: 600;">${dish.nazwa}</div>
                    <div style="font-size: 12px; color: #666;">${dish.typ || '‚Äî'}</div>
                </div>
            `).join('');
        }

        async function selectDish(dishId) {
            const sectionId = document.getElementById('dishSectionId').value;
            const porcje = prompt('Liczba porcji:', '10');
            if (!porcje) return;
            
            try {
                const response = await fetch(`/api/event-sections/${sectionId}/dishes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dish_id: dishId,
                        liczba_porcji: parseInt(porcje)
                    })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd dodawania dania');
                
                await loadSectionsAndDishes();
                await loadTasks(); // Od≈õwie≈º zadania (mog≈Çy siƒô dodaƒá z receptur)
                renderTimeline();
                closeDishModal();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd dodawania dania');
            }
        }

        async function deleteDish(id) {
            if (!confirm('UsunƒÖƒá danie? (zadania z receptur te≈º zostanƒÖ usuniƒôte)')) return;
            
            try {
                const response = await fetch(`/api/event-section-dishes/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                await loadSectionsAndDishes();
                await loadTasks();
                renderTimeline();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd usuwania dania');
            }
        }

        // ========== MODALS - ZADANIE ==========
        
        function openAddTaskModal(dayId) {
            document.getElementById('taskForm').reset();
            document.getElementById('taskDayId').value = dayId === 'production' ? productionDayId : dayId;
            document.getElementById('taskType').value = dayId === 'production' ? 'production' : 'regular';
            
            // Poka≈º pole daty tylko dla produkcji
            const dateGroup = document.getElementById('taskDateGroup');
            dateGroup.style.display = dayId === 'production' ? 'block' : 'none';
            
            document.getElementById('taskModal').style.display = 'flex';
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
        }

        async function saveTask(e) {
            e.preventDefault();
            
            const dayId = document.getElementById('taskDayId').value;
            const nazwa = document.getElementById('taskNazwa').value;
            const dataWykonania = document.getElementById('taskDataWykonania').value || null;
            
            try {
                const response = await fetch(`/api/event-days/${dayId}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nazwa,
                        data_wykonania: dataWykonania
                    })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                await loadTasks();
                renderTimeline();
                closeTaskModal();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd zapisu zadania');
            }
        }

        async function toggleTask(taskId, checked) {
            try {
                await fetch(`/api/event-tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zrobione: checked })
                });
                
                await loadTasks();
                renderTimeline();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd aktualizacji zadania');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('UsunƒÖƒá zadanie?')) return;
            
            try {
                const response = await fetch(`/api/event-tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }
                
                await loadTasks();
                renderTimeline();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå ' + error.message);
            }
        }

        // ========== MODAL - PRZENIE≈ö ZADANIE ==========
        
        function openMoveTaskModal(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            document.getElementById('moveTaskId').value = taskId;
            document.getElementById('moveTaskInfo').textContent = `Przenie≈õ: "${task.nazwa}"`;
            
            // Lista dni
            const list = document.getElementById('moveDaysList');
            const days = [
                { id: productionDayId, nazwa: 'üì¶ Produkcja' },
                ...eventDays.filter(d => d.kolejnosc >= 0).map(d => ({
                    id: d.id,
                    nazwa: `Dzie≈Ñ ${d.kolejnosc + 1} - ${d.nazwa}`
                }))
            ];
            
            list.innerHTML = days.map(day => `
                <button class="btn btn-primary" onclick="moveTaskToDay(${taskId}, ${day.id})" 
                        ${task.event_day_id === day.id ? 'disabled' : ''}>
                    ${day.nazwa} ${task.event_day_id === day.id ? '(aktualny)' : ''}
                </button>
            `).join('');
            
            document.getElementById('moveTaskModal').style.display = 'flex';
        }

        function closeMoveTaskModal() {
            document.getElementById('moveTaskModal').style.display = 'none';
        }

        async function moveTaskToDay(taskId, dayId) {
            try {
                await fetch(`/api/event-tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_day_id: dayId })
                });
                
                await loadTasks();
                renderTimeline();
                closeMoveTaskModal();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd przenoszenia zadania');
            }
        }

        // ========== UTILS ==========
        
        function getEventTypeName(typ) {
            const types = {
                'event': 'Wydarzenie',
                'catering': 'Catering',
                'delivery': 'Dostawa'
            };
            return types[typ] || typ;
        }

        // Zamknij modal klikniƒôciem poza
        window.onclick = function(event) {
            const modals = ['sectionModal', 'dishModal', 'taskModal', 'moveTaskModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
        // ========== PDF EXPORT ==========

function togglePdfMenu() {
    const menu = document.getElementById('pdfMenu');
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

function generatePDF(type) {
    const url = `/api/events/${eventId}/pdf/${type}`;
    window.open(url, '_blank');
    togglePdfMenu();
}

// Zamknij menu klikniƒôciem poza
document.addEventListener('click', (e) => {
    const menu = document.getElementById('pdfMenu');
    const button = e.target.closest('button');
    if (menu.style.display === 'block' && !button?.textContent?.includes('Generuj PDF')) {
        menu.style.display = 'none';
    }
});
    </script>
</body>
</html>
