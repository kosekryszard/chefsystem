<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Eventy</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Eventy</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html" class="active">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry status√≥w -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterEvents('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="draft" onclick="filterEvents('draft')">
                    üìù Robocze
                </button>
                <button class="filter-btn" data-filter="active" onclick="filterEvents('active')">
                    ‚úÖ Aktywne
                </button>
                <button class="filter-btn" data-filter="completed" onclick="filterEvents('completed')">
                    ‚úîÔ∏è Zako≈Ñczone
                </button>
                <button class="filter-btn" data-filter="archived" onclick="filterEvents('archived')">
                    üì¶ Archiwum
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Lista event√≥w</h2>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj event</button>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj event..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid event√≥w -->
            <div class="items-grid" id="eventsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie event√≥w...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji (uproszczony - zachowaj pe≈Çny z obecnego events.html) -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj event</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="eventForm" onsubmit="saveEvent(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="form-group">
                        <label>Nazwa eventu *</label>
                        <input type="text" id="nazwa" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Data rozpoczƒôcia *</label>
                            <input type="date" id="data_rozpoczecia" required>
                        </div>
                        <div class="form-group">
                            <label>Data zako≈Ñczenia *</label>
                            <input type="date" id="data_zakonczenia" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Lokalizacja</label>
                        <input type="text" id="lokalizacja">
                    </div>

                    <div class="form-group">
                        <label>Klient</label>
                        <input type="text" id="klient">
                    </div>

                    <div class="form-group">
                        <label>Opis</label>
                        <textarea id="opis" rows="3"></textarea>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-success">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allEvents = [];
        let filteredEvents = [];
        let currentFilter = 'all';

        window.addEventListener('DOMContentLoaded', () => {
            loadEvents();
        });

        async function loadEvents() {
            try {
                const response = await fetch(`${API_URL}/api/events`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allEvents = await response.json();
                filteredEvents = [...allEvents];
                
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('eventsGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        function filterEvents(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredEvents = allEvents.filter(evt => {
                // Search
                const matchesSearch = evt.nazwa.toLowerCase().includes(searchTerm) ||
                    (evt.klient && evt.klient.toLowerCase().includes(searchTerm)) ||
                    (evt.lokalizacja && evt.lokalizacja.toLowerCase().includes(searchTerm));
                
                // Status filter
                let matchesStatus = true;
                if (currentFilter !== 'all') {
                    matchesStatus = evt.status === currentFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('eventsGrid');
            
            if (filteredEvents.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredEvents.map(evt => {
                // Status badge
                const statusBadges = {
                    'draft': '<span class="badge badge-status-draft">üìù Robocze</span>',
                    'active': '<span class="badge badge-status-active">‚úÖ Aktywne</span>',
                    'completed': '<span class="badge badge-status-completed">‚úîÔ∏è Zako≈Ñczone</span>',
                    'archived': '<span class="badge badge-status-archived">üì¶ Archiwum</span>'
                };
                const statusBadge = statusBadges[evt.status] || '';
                
                // Dates
                const dateStart = evt.data_rozpoczecia ? new Date(evt.data_rozpoczecia).toLocaleDateString('pl-PL') : '';
                const dateEnd = evt.data_zakonczenia ? new Date(evt.data_zakonczenia).toLocaleDateString('pl-PL') : '';
                const datesStr = dateStart && dateEnd ? `${dateStart} - ${dateEnd}` : '';
                
                // Description parts
                const descParts = [];
                if (evt.klient) descParts.push(`Klient: ${evt.klient}`);
                if (evt.lokalizacja) descParts.push(`Lokalizacja: ${evt.lokalizacja}`);
                const descStr = descParts.length > 0 ? descParts.join(' | ') : evt.opis || '';
                
                return `
                    <div class="item-card" data-id="${evt.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewEvent(${evt.id})">
                            <h3 class="item-card-title">${evt.nazwa}</h3>
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Opis -->
                            ${descStr ? `<p class="item-card-description">${descStr}</p>` : ''}
                            
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                ${datesStr ? `<span class="badge badge-type">üìÖ ${datesStr}</span>` : ''}
                                ${statusBadge}
                            </div>
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editEvent(${evt.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateEvent(${evt.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-status" onclick="showStatusMenu(event, ${evt.id})">
                                    üìä Status
                                </button>
                                <button class="action-btn btn-plan" onclick="event.stopPropagation(); planEvent(${evt.id})">
                                    üìÖ Planuj
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteEvent(${evt.id})">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FLOATING STATUS MENU === 
        function showStatusMenu(event, eventId) {
            event.stopPropagation();
            
            const existing = document.getElementById('floatingStatusMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'floatingStatusMenu';
            menu.className = 'floating-status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${eventId}, 'draft')">üìù Robocze</div>
                <div onclick="changeStatus(${eventId}, 'active')">‚úÖ Aktywne</div>
                <div onclick="changeStatus(${eventId}, 'completed')">‚úîÔ∏è Zako≈Ñczone</div>
                <div onclick="changeStatus(${eventId}, 'archived')">üì¶ Archiwum</div>
            `;
            
            document.body.appendChild(menu);
            
            const buttonRect = event.target.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            let top, left;
            
            if (buttonRect.bottom + menuRect.height + 10 < viewportHeight) {
                top = buttonRect.bottom + 5;
            } else {
                top = buttonRect.top - menuRect.height - 5;
            }
            
            if (buttonRect.left + menuRect.width > viewportWidth) {
                left = buttonRect.right - menuRect.width;
            } else {
                left = buttonRect.left;
            }
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        async function changeStatus(eventId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/events/${eventId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                document.getElementById('floatingStatusMenu')?.remove();
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zmiany statusu');
            }
        }

        // PodglƒÖd eventu (nowa strona)
        function viewEvent(eventId) {
            window.location.href = `events-view.html?id=${eventId}`;
        }

        // Planowanie eventu (istniejƒÖca strona)
        function planEvent(eventId) {
            window.location.href = `event-planning.html?id=${eventId}`;
        }

        // === CRUD OPERATIONS ===
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj event';
            document.getElementById('eventForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        async function editEvent(id) {
            const evt = allEvents.find(e => e.id === id);
            if (!evt) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj event';
            document.getElementById('editId').value = evt.id;
            document.getElementById('nazwa').value = evt.nazwa || '';
            document.getElementById('lokalizacja').value = evt.lokalizacja || '';
            document.getElementById('klient').value = evt.klient || '';
            document.getElementById('opis').value = evt.opis || '';
            
            if (evt.data_rozpoczecia) {
                document.getElementById('data_rozpoczecia').value = evt.data_rozpoczecia.split('T')[0];
            }
            if (evt.data_zakonczenia) {
                document.getElementById('data_zakonczenia').value = evt.data_zakonczenia.split('T')[0];
            }
            
            document.getElementById('eventModal').style.display = 'block';
        }

        async function saveEvent(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
                nazwa: document.getElementById('nazwa').value,
                data_rozpoczecia: document.getElementById('data_rozpoczecia').value,
                data_zakonczenia: document.getElementById('data_zakonczenia').value,
                lokalizacja: document.getElementById('lokalizacja').value,
                klient: document.getElementById('klient').value,
                opis: document.getElementById('opis').value
            };
            
            try {
                const url = id ? `${API_URL}/api/events/${id}` : `${API_URL}/api/events`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                alert(id ? 'Zapisano zmiany' : 'Dodano event');
                closeModal();
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        async function duplicateEvent(id) {
            const evt = allEvents.find(e => e.id === id);
            if (!evt) return;
            
            if (!confirm(`Duplikowaƒá event "${evt.nazwa}"?`)) return;
            
            const newEvent = {
                nazwa: evt.nazwa + ' (kopia)',
                data_rozpoczecia: evt.data_rozpoczecia,
                data_zakonczenia: evt.data_zakonczenia,
                lokalizacja: evt.lokalizacja,
                klient: evt.klient,
                opis: evt.opis,
                status: 'draft'
            };
            
            try {
                const response = await fetch(`${API_URL}/api/events`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEvent)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
                
                alert('Zduplikowano event (bez dni i grup)');
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd duplikowania: ' + error.message);
            }
        }

        async function deleteEvent(id) {
            const evt = allEvents.find(e => e.id === id);
            if (!evt) return;
            
            if (!confirm(`Czy na pewno usunƒÖƒá "${evt.nazwa}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/events/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                alert('Usuniƒôto event');
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd usuwania: ' + error.message);
            }
        }

        // Zamykanie modala klikniƒôciem poza
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
