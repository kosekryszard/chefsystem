<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Grupy</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Grupy</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html" class="active">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry status√≥w -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterGroups('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="draft" onclick="filterGroups('draft')">
                    üìù Robocze
                </button>
                <button class="filter-btn" data-filter="active" onclick="filterGroups('active')">
                    ‚úÖ Aktywne
                </button>
                <button class="filter-btn" data-filter="completed" onclick="filterGroups('completed')">
                    ‚úîÔ∏è Zako≈Ñczone
                </button>
                <button class="filter-btn" data-filter="archived" onclick="filterGroups('archived')">
                    üì¶ Archiwum
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Lista grup</h2>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj grupƒô</button>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj grupƒô..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid grup -->
            <div class="items-grid" id="groupsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie grup...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji (uproszczony - zachowaj pe≈Çny z obecnego groups.html) -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj grupƒô</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="groupForm" onsubmit="saveGroup(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="form-group">
                        <label>Nazwa grupy *</label>
                        <input type="text" id="nazwa" required>
                    </div>

                    <div class="form-group">
                        <label>Liczba uczestnik√≥w *</label>
                        <input type="number" id="liczba_uczestnikow" required min="1">
                    </div>

                    <div class="form-group">
                        <label>Opis</label>
                        <textarea id="opis" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Data rozpoczƒôcia</label>
                            <input type="date" id="data_rozpoczecia">
                        </div>
                        <div class="form-group">
                            <label>Data zako≈Ñczenia</label>
                            <input type="date" id="data_zakonczenia">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-success">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allGroups = [];
        let filteredGroups = [];
        let currentFilter = 'all';

        window.addEventListener('DOMContentLoaded', () => {
            loadGroups();
        });

        async function loadGroups() {
            try {
                const response = await fetch(`${API_URL}/api/groups`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allGroups = await response.json();
                filteredGroups = [...allGroups];
                
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('groupsGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        function filterGroups(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredGroups = allGroups.filter(group => {
                // Search
                const matchesSearch = group.nazwa.toLowerCase().includes(searchTerm);
                
                // Status filter
                let matchesStatus = true;
                if (currentFilter !== 'all') {
                    matchesStatus = group.status === currentFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('groupsGrid');
            
            if (filteredGroups.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredGroups.map(group => {
                // Status badge
                const statusBadges = {
                    'draft': '<span class="badge badge-status-draft">üìù Robocze</span>',
                    'active': '<span class="badge badge-status-active">‚úÖ Aktywne</span>',
                    'completed': '<span class="badge badge-status-completed">‚úîÔ∏è Zako≈Ñczone</span>',
                    'archived': '<span class="badge badge-status-archived">üì¶ Archiwum</span>'
                };
                const statusBadge = statusBadges[group.status] || '';
                
                // Dates
                const dates = [];
                if (group.data_rozpoczecia) {
                    dates.push(`Od: ${new Date(group.data_rozpoczecia).toLocaleDateString('pl-PL')}`);
                }
                if (group.data_zakonczenia) {
                    dates.push(`Do: ${new Date(group.data_zakonczenia).toLocaleDateString('pl-PL')}`);
                }
                const datesStr = dates.length > 0 ? dates.join(' | ') : '';
                
                return `
                    <div class="item-card" data-id="${group.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewGroup(${group.id})">
                            <h3 class="item-card-title">${group.nazwa}</h3>
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Opis -->
                            ${group.opis ? `<p class="item-card-description">${group.opis}</p>` : ''}
                            
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                <span class="badge badge-type">üë• ${group.liczba_uczestnikow} os√≥b</span>
                                ${statusBadge}
                            </div>
                            
                            ${datesStr ? `<p style="font-size: 12px; color: #666; margin-top: 10px;">${datesStr}</p>` : ''}
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editGroup(${group.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateGroup(${group.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-status" onclick="showStatusMenu(event, ${group.id})">
                                    üìä Status
                                </button>
                                <button class="action-btn btn-plan" onclick="event.stopPropagation(); planGroup(${group.id})">
                                    üìÖ Planuj
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteGroup(${group.id})">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FLOATING STATUS MENU === 
        function showStatusMenu(event, groupId) {
            event.stopPropagation();
            
            const existing = document.getElementById('floatingStatusMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'floatingStatusMenu';
            menu.className = 'floating-status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${groupId}, 'draft')">üìù Robocze</div>
                <div onclick="changeStatus(${groupId}, 'active')">‚úÖ Aktywne</div>
                <div onclick="changeStatus(${groupId}, 'completed')">‚úîÔ∏è Zako≈Ñczone</div>
                <div onclick="changeStatus(${groupId}, 'archived')">üì¶ Archiwum</div>
            `;
            
            document.body.appendChild(menu);
            
            const buttonRect = event.target.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            let top, left;
            
            if (buttonRect.bottom + menuRect.height + 10 < viewportHeight) {
                top = buttonRect.bottom + 5;
            } else {
                top = buttonRect.top - menuRect.height - 5;
            }
            
            if (buttonRect.left + menuRect.width > viewportWidth) {
                left = buttonRect.right - menuRect.width;
            } else {
                left = buttonRect.left;
            }
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        async function changeStatus(groupId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/groups/${groupId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                document.getElementById('floatingStatusMenu')?.remove();
                loadGroups();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zmiany statusu');
            }
        }

        // PodglƒÖd grupy (nowa strona)
        function viewGroup(groupId) {
            window.location.href = `groups-view.html?id=${groupId}`;
        }

        // Planowanie grupy (istniejƒÖca strona)
        function planGroup(groupId) {
            window.location.href = `group-planning.html?id=${groupId}`;
        }

        // === CRUD OPERATIONS ===
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj grupƒô';
            document.getElementById('groupForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('groupModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('groupModal').style.display = 'none';
        }

        async function editGroup(id) {
            const group = allGroups.find(g => g.id === id);
            if (!group) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj grupƒô';
            document.getElementById('editId').value = group.id;
            document.getElementById('nazwa').value = group.nazwa || '';
            document.getElementById('liczba_uczestnikow').value = group.liczba_uczestnikow || '';
            document.getElementById('opis').value = group.opis || '';
            
            // Daty w formacie YYYY-MM-DD
            if (group.data_rozpoczecia) {
                document.getElementById('data_rozpoczecia').value = group.data_rozpoczecia.split('T')[0];
            }
            if (group.data_zakonczenia) {
                document.getElementById('data_zakonczenia').value = group.data_zakonczenia.split('T')[0];
            }
            
            document.getElementById('groupModal').style.display = 'block';
        }

        async function saveGroup(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
                nazwa: document.getElementById('nazwa').value,
                liczba_uczestnikow: parseInt(document.getElementById('liczba_uczestnikow').value),
                opis: document.getElementById('opis').value,
                data_rozpoczecia: document.getElementById('data_rozpoczecia').value || null,
                data_zakonczenia: document.getElementById('data_zakonczenia').value || null
            };
            
            try {
                const url = id ? `${API_URL}/api/groups/${id}` : `${API_URL}/api/groups`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                alert(id ? 'Zapisano zmiany' : 'Dodano grupƒô');
                closeModal();
                loadGroups();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        async function duplicateGroup(id) {
            const group = allGroups.find(g => g.id === id);
            if (!group) return;
            
            if (!confirm(`Duplikowaƒá grupƒô "${group.nazwa}"?`)) return;
            
            const newGroup = {
                nazwa: group.nazwa + ' (kopia)',
                liczba_uczestnikow: group.liczba_uczestnikow,
                opis: group.opis,
                data_rozpoczecia: group.data_rozpoczecia,
                data_zakonczenia: group.data_zakonczenia,
                status: 'draft'
            };
            
            try {
                const response = await fetch(`${API_URL}/api/groups`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newGroup)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
                
                alert('Zduplikowano grupƒô (bez planu posi≈Çk√≥w)');
                loadGroups();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd duplikowania: ' + error.message);
            }
        }

        async function deleteGroup(id) {
            const group = allGroups.find(g => g.id === id);
            if (!group) return;
            
            if (!confirm(`Czy na pewno usunƒÖƒá "${group.nazwa}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/groups/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                alert('Usuniƒôto grupƒô');
                loadGroups();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd usuwania: ' + error.message);
            }
        }

        // Zamykanie modala klikniƒôciem poza
        window.onclick = function(event) {
            const modal = document.getElementById('groupModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
