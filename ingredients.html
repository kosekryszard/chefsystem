<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Surowce</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Surowce</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html" class="active">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry podstawowe (diety) -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterIngredients('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="vegan" onclick="filterIngredients('vegan')">
                    üå± Wega≈Ñskie
                </button>
                <button class="filter-btn" data-filter="vegetarian" onclick="filterIngredients('vegetarian')">
                    ü•¨ Wegetaria≈Ñskie
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Baza surowc√≥w</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="toggle-advanced-filters" onclick="toggleAdvancedFilters()">
                        üîç Filtry zaawansowane
                    </button>
                    <button class="btn btn-secondary" onclick="openImportModal()">üì§ Import CSV</button>
                    <button class="btn btn-secondary" onclick="exportIngredients()">üì• Eksport CSV</button>
                    <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj surowiec</button>
                </div>
            </div>

            <!-- Filtry zaawansowane (ukryte domy≈õlnie) -->
            <div id="advancedFilters" class="advanced-filters" style="display: none;">
                <div class="advanced-filters-grid">
                    <!-- Typ -->
                    <div class="filter-group">
                        <label>Typ</label>
                        <select id="filterType" onchange="applyFilters()">
                            <option value="">Wszystkie</option>
                        </select>
                    </div>
                    
                    <!-- Grupa -->
                    <div class="filter-group">
                        <label>Grupa</label>
                        <select id="filterGrupa" onchange="applyFilters()">
                            <option value="">Wszystkie</option>
                        </select>
                    </div>

                    <!-- Alergeny -->
                    <div class="filter-group">
                        <label>Bez alergen√≥w</label>
                        <select id="filterAllergen" onchange="applyFilters()">
                            <option value="">Wszystkie</option>
                            <option value="1">Bez glutenu</option>
                            <option value="3">Bez jaj</option>
                            <option value="7">Bez mleka</option>
                            <option value="5">Bez orzeszk√≥w</option>
                        </select>
                    </div>
                    
                    <!-- Cena max -->
                    <div class="filter-group">
                        <label>Cena max (PLN)</label>
                        <input type="number" id="filterPrice" placeholder="np. 50" onchange="applyFilters()">
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="resetFilters()" style="margin-top: 15px;">
                    üîÑ Wyczy≈õƒá filtry
                </button>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj surowiec..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid surowc√≥w -->
            <div class="items-grid" id="ingredientsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie surowc√≥w...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Dodaj/Edytuj -->
    <div id="ingredientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj nowy surowiec</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Nazwa *</label>
                        <input type="text" id="nazwa" required>
                    </div>
                    <div class="form-group">
                        <label>Jednostka miary *</label>
                        <select id="jm_podstawowa" required>
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="ml">ml</option>
                            <option value="szt">szt</option>
                            <option value="op">op</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Typ</label>
                        <select id="typ">
                            <option value="">Wybierz typ</option>
                            <option value="warzywo">Warzywo</option>
                            <option value="owoc">Owoc</option>
                            <option value="miƒôso">Miƒôso</option>
                            <option value="wƒôdlina">Wƒôdlina</option>
                            <option value="nabia≈Ç">Nabia≈Ç</option>
                            <option value="przyprawa">Przyprawa</option>
                            <option value="zio≈Ço_≈õwie≈ºe">Zio≈Ço ≈õwie≈ºe</option>
                            <option value="inne">Inne</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grupa</label>
                        <input type="text" id="grupa">
                    </div>
                    <div class="form-group">
                        <label>Dzia≈Ç</label>
                        <select id="dzial">
                            <option value="kuchnia">Kuchnia</option>
                            <option value="bar">Bar</option>
                            <option value="og√≥lne">Og√≥lne</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Dieta</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="wegetarianski"> Wegetaria≈Ñski</label>
                            <label><input type="checkbox" id="weganski"> Wega≈Ñski</label>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Alergeny (14 UE)</label>
                        <div id="allergensCheckboxes" class="checkbox-group"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Import surowc√≥w z CSV</h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            
            <div style="padding: 20px;">
                <!-- Upload area -->
                <div id="fileUploadArea" class="file-upload-area" onclick="document.getElementById('csvFileInput').click()">
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    <p style="font-size: 1.2em; margin: 0 0 10px 0;">üìÅ Kliknij lub przeciƒÖgnij plik CSV</p>
                    <p style="color: #666; font-size: 0.9em; margin: 0;">Format: id,nazwa,typ,grupa,dzial,jm_podstawowa,wegetarianski,weganski,alergeny</p>
                </div>

                <!-- Preview area -->
                <div id="importPreviewContainer" style="display: none;">
                    <div class="import-options">
                        <h3>Opcje importu</h3>
                        <label>
                            <input type="radio" name="duplicateAction" value="skip" checked>
                            ‚ùå Pomi≈Ñ duplikaty (nie importuj je≈õli nazwa ju≈º istnieje)
                        </label>
                        <label>
                            <input type="radio" name="duplicateAction" value="overwrite">
                            üîÑ Nadpisz istniejƒÖce (zaktualizuj je≈õli nazwa ju≈º istnieje)
                        </label>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            <strong>Znaleziono:</strong> 
                            <span id="totalRows">0</span> wierszy | 
                            <span id="newRows" style="color: #28a745;">0 nowych</span> | 
                            <span id="duplicateRows" style="color: #ffc107;">0 duplikat√≥w</span> |
                            <span id="errorRows" style="color: #dc3545;">0 b≈Çƒôd√≥w</span>
                        </p>
                    </div>

                    <div id="importPreviewTable"></div>

                    <!-- Progress bar -->
                    <div class="progress-bar" id="importProgress">
                        <div class="progress-bar-fill" id="importProgressFill">0%</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Anuluj</button>
                        <button type="button" class="btn btn-primary" onclick="executeImport()" id="importButton">
                            ‚úÖ Importuj
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allIngredients = [];
        let filteredIngredients = [];
        let currentFilter = 'all';

        const ALLERGENS = {
            1: { kod: 'GLU', nazwa: 'Gluten' },
            2: { kod: 'SKO', nazwa: 'Skorupiaki' },
            3: { kod: 'JAJ', nazwa: 'Jaja' },
            4: { kod: 'RYB', nazwa: 'Ryby' },
            5: { kod: 'ORZ', nazwa: 'Orzeszki' },
            6: { kod: 'SOJ', nazwa: 'Soja' },
            7: { kod: 'MLE', nazwa: 'Mleko' },
            8: { kod: 'ORS', nazwa: 'Orzechy' },
            9: { kod: 'SEL', nazwa: 'Seler' },
            10: { kod: 'GOR', nazwa: 'Gorczyca' },
            11: { kod: 'SEZ', nazwa: 'Sezam' },
            12: { kod: 'SIA', nazwa: 'Dwutlenek siarki' },
            13: { kod: 'LUB', nazwa: '≈Åubin' },
            14: { kod: 'MIE', nazwa: 'Miƒôczaki' }
        };

        window.addEventListener('DOMContentLoaded', () => {
            loadIngredients();
        });

        async function loadIngredients() {
            try {
                const response = await fetch(`${API_URL}/api/ingredients`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allIngredients = await response.json();
                filteredIngredients = [...allIngredients];
                
                populateFilters();
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('ingredientsGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        function populateFilters() {
            // Typy
            const types = [...new Set(allIngredients.map(i => i.typ).filter(Boolean))];
            const typeSelect = document.getElementById('filterType');
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Grupy
            const grupy = [...new Set(allIngredients.map(i => i.grupa).filter(Boolean))];
            const grupaSelect = document.getElementById('filterGrupa');
            grupy.forEach(grupa => {
                const option = document.createElement('option');
                option.value = grupa;
                option.textContent = grupa;
                grupaSelect.appendChild(option);
            });
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('advancedFilters');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function filterIngredients(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const grupaFilter = document.getElementById('filterGrupa').value;
            const allergenFilter = document.getElementById('filterAllergen').value;
            const priceFilter = parseFloat(document.getElementById('filterPrice').value) || null;
            
            filteredIngredients = allIngredients.filter(ing => {
                // Search
                const matchesSearch = ing.nazwa.toLowerCase().includes(searchTerm);
                
                // Type
                const matchesType = !typeFilter || ing.typ === typeFilter;
                
                // Grupa
                const matchesGrupa = !grupaFilter || ing.grupa === grupaFilter;
                
                // Diet
                let matchesDiet = true;
                if (currentFilter === 'vegan') {
                    matchesDiet = ing.weganski === true;
                } else if (currentFilter === 'vegetarian') {
                    matchesDiet = ing.wegetarianski === true;
                }
                
                // Allergen (bez wybranego alergenu)
                let matchesAllergen = true;
                if (allergenFilter) {
                    const allergenId = parseInt(allergenFilter);
                    matchesAllergen = !ing.alergeny || !ing.alergeny.includes(allergenId);
                }
                
                // Price
                let matchesPrice = true;
                if (priceFilter && ing.cena_aktualna) {
                    matchesPrice = ing.cena_aktualna <= priceFilter;
                }
                
                return matchesSearch && matchesType && matchesGrupa && matchesDiet && matchesAllergen && matchesPrice;
            });
            
            renderGrid();
        }

        function resetFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterGrupa').value = '';
            document.getElementById('filterAllergen').value = '';
            document.getElementById('filterPrice').value = '';
            applyFilters();
        }

        function renderGrid() {
            const grid = document.getElementById('ingredientsGrid');
            
            if (filteredIngredients.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredIngredients.map(ing => {
                // Alergeny
                const allergens = Array.isArray(ing.alergeny) ? 
                    ing.alergeny.map(id => {
                        const allergen = ALLERGENS[id];
                        return allergen ? `<span class="allergen-tag">${allergen.kod}</span>` : '';
                    }).join('') : '';
                
                // Diet badges
                const dietBadges = [];
                if (ing.weganski) dietBadges.push('<span class="badge badge-vegan">üå± Vegan</span>');
                if (ing.wegetarianski) dietBadges.push('<span class="badge badge-vegetarian">ü•¨ Wege</span>');
                
                return `
                    <div class="item-card" data-id="${ing.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewIngredient(${ing.id})">
                            <h3 class="item-card-title">${ing.nazwa}</h3>
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                ${ing.typ ? `<span class="badge badge-type">${ing.typ}</span>` : ''}
                                ${ing.jm_podstawowa ? `<span class="badge badge-jm">${ing.jm_podstawowa}</span>` : ''}
                                ${ing.cena_aktualna ? `<span class="badge badge-price">${ing.cena_aktualna} PLN</span>` : ''}
                                ${dietBadges.join('')}
                            </div>
                            
                            ${allergens ? `<div style="margin-top: 10px;">
                                <small style="color: #666;">Alergeny:</small><br>
                                ${allergens}
                            </div>` : ''}
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editIngredient(${ing.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateIngredient(${ing.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteIngredient(${ing.id})">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewIngredient(ingredientId) {
            window.location.href = `ingredients-view.html?id=${ingredientId}`;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj surowiec';
            document.getElementById('ingredientForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('ingredientModal').style.display = 'block';
        }

        async function editIngredient(id) {
            const ingredient = allIngredients.find(i => i.id === id);
            if (!ingredient) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj surowiec';
            document.getElementById('editId').value = ingredient.id;
            document.getElementById('nazwa').value = ingredient.nazwa || '';
            document.getElementById('jm_podstawowa').value = ingredient.jm_podstawowa || '';
            document.getElementById('typ').value = ingredient.typ || '';
            document.getElementById('wegetarianski').checked = ingredient.wegetarianski || false;
            document.getElementById('weganski').checked = ingredient.weganski || false;
            document.getElementById('alergeny').value = Array.isArray(ingredient.alergeny) ? ingredient.alergeny.join(',') : '';
            
            document.getElementById('ingredientModal').style.display = 'block';
        }

        function duplicateIngredient(id) {
            alert('Duplikowanie - zaimplementuj analogicznie do recipes/dishes');
        }

        async function saveIngredient(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
                nazwa: document.getElementById('nazwa').value,
                jm_podstawowa: document.getElementById('jm_podstawowa').value,
                typ: document.getElementById('typ').value,
                wegetarianski: document.getElementById('wegetarianski').checked,
                weganski: document.getElementById('weganski').checked,
                alergeny: document.getElementById('alergeny').value
                    .split(',')
                    .map(x => parseInt(x.trim()))
                    .filter(x => !isNaN(x))
            };
            
            try {
                const url = id ? `${API_URL}/api/ingredients/${id}` : `${API_URL}/api/ingredients`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                alert(id ? 'Zapisano zmiany' : 'Dodano surowiec');
                closeModal();
                loadIngredients();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        function deleteIngredient(id) {
            if (!confirm('Czy na pewno usunƒÖƒá ten surowiec?')) return;
            
            fetch(`${API_URL}/api/ingredients/${id}`, { method: 'DELETE' })
                .then(r => {
                    if (!r.ok) throw new Error('B≈ÇƒÖd usuwania');
                    alert('Usuniƒôto surowiec');
                    loadIngredients();
                })
                .catch(e => alert('B≈ÇƒÖd: ' + e.message));
        }

        async function duplicateIngredient(id) {
    const ingredient = allIngredients.find(i => i.id === id);
    if (!ingredient) return;
    
    if (!confirm(`Duplikowaƒá surowiec "${ingredient.nazwa}"?`)) return;
    
    const newIngredient = {
        nazwa: ingredient.nazwa + ' (kopia)',
        typ: ingredient.typ,
        grupa: ingredient.grupa,
        dzial: ingredient.dzial,
        jm_podstawowa: ingredient.jm_podstawowa,
        cena_aktualna: ingredient.cena_aktualna,
        alergeny: ingredient.alergeny,
        wegetarianski: ingredient.wegetarianski,
        weganski: ingredient.weganski
    };
    
    try {
        const response = await fetch(`${API_URL}/api/ingredients`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newIngredient)
        });
        
        if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
        
        alert('Zduplikowano surowiec');
        loadIngredients();
    } catch (error) {
        console.error('Error:', error);
        alert('B≈ÇƒÖd duplikowania: ' + error.message);
    }
}

        // Eksport do CSV
    async function exportIngredients() {
        try {
            const response = await fetch(`${API_URL}/api/ingredients/export/csv`);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `surowce_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert('B≈ÇƒÖd eksportu: ' + err.message);
        }
    }

        // ============ IMPORT CSV ============

    function openImportModal() {
        document.getElementById('importModal').style.display = 'block';
        document.getElementById('importPreviewContainer').style.display = 'none';
        document.getElementById('fileUploadArea').style.display = 'block';
        document.getElementById('csvFileInput').value = '';
        importData = null;
        duplicatesInfo = null;
    }


    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }


    </script>
</body>
</html>
