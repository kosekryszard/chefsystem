<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Karty Menu</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Karty Menu</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html" class="active">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry status√≥w -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterMenuCards('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="robocza" onclick="filterMenuCards('robocza')">
                    üìù Robocze
                </button>
                <button class="filter-btn" data-filter="sta≈Ça" onclick="filterMenuCards('sta≈Ça')">
                    ‚úÖ Sta≈Çe
                </button>
                <button class="filter-btn" data-filter="sezonowa" onclick="filterMenuCards('sezonowa')">
                    üå∏ Sezonowe
                </button>
                <button class="filter-btn" data-filter="eventowa" onclick="filterMenuCards('eventowa')">
                    üéâ Eventowe
                </button>
                <button class="filter-btn" data-filter="archiwalna" onclick="filterMenuCards('archiwalna')">
                    üì¶ Archiwum
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Karty menu</h2>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj kartƒô</button>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj kartƒô..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid kart -->
            <div class="items-grid" id="menuCardsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie kart menu...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji (uproszczony - zachowaj pe≈Çny z obecnego menu-cards.html) -->
    <div id="menuCardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj kartƒô menu</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="menuCardForm" onsubmit="saveMenuCard(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="form-group">
                        <label>Lokal *</label>
                        <select id="lokal" required>
                            <option value="Szczelinka">Szczelinka</option>
                            <option value="Pasterka">Pasterka</option>
                            <option value="Stolove">Stolove</option>
                            <option value="Szczeliniec">Szczeliniec</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Typ karty *</label>
                            <select id="typ" required>
                                <option value="sta≈Ça">Sta≈Ça</option>
                                <option value="sezonowa">Sezonowa</option>
                                <option value="eventowa">Eventowa</option>
                                <option value="cateringowa">Cateringowa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lokal</label>
                            <input type="text" id="lokal" placeholder="Nazwa lokalu/restauracji">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Data obowiƒÖzywania od</label>
                            <input type="date" id="data_od">
                        </div>
                        <div class="form-group">
                            <label>Data obowiƒÖzywania do</label>
                            <input type="date" id="data_do">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-success">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allMenuCards = [];
        let filteredMenuCards = [];
        let currentFilter = 'all';

        window.addEventListener('DOMContentLoaded', () => {
            loadMenuCards();
        });

        async function loadMenuCards() {
            try {
                const response = await fetch(`${API_URL}/api/menu-cards`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allMenuCards = await response.json();
                filteredMenuCards = [...allMenuCards];
                
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('menuCardsGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        function filterMenuCards(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredMenuCards = allMenuCards.filter(card => {
                // Search
                const matchesSearch = card.nazwa.toLowerCase().includes(searchTerm) ||
                    (card.typ && card.typ.toLowerCase().includes(searchTerm)) ||
                    (card.lokal && card.lokal.toLowerCase().includes(searchTerm));
                
                // Status filter
                let matchesStatus = true;
                if (currentFilter !== 'all') {
                    matchesStatus = card.status === currentFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('menuCardsGrid');
            
            if (filteredMenuCards.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredMenuCards.map(card => {
                // Status badge
                const statusBadges = {
                    'robocza': '<span class="badge badge-status-robocza">üìù Robocze</span>',
                    'active': '<span class="badge badge-status-active">‚úÖ Aktywne</span>',
                    'archived': '<span class="badge badge-status-archived">üì¶ Archiwum</span>'
                };
                const statusBadge = statusBadges[card.status] || '';
                
                // Description
                const descParts = [];
                if (card.lokal) descParts.push(`Lokal: ${card.lokal}`);
                const descStr = descParts.length > 0 ? descParts.join(' | ') : '';
                
                // Dates
                const dates = [];
                if (card.data_od) {
                    dates.push(`Od: ${new Date(card.data_od).toLocaleDateString('pl-PL')}`);
                }
                if (card.data_do) {
                    dates.push(`Do: ${new Date(card.data_do).toLocaleDateString('pl-PL')}`);
                }
                const datesStr = dates.length > 0 ? dates.join(' | ') : '';
                
                return `
                    <div class="item-card" data-id="${card.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewMenuCard(${card.id})">
                            <h3 class="item-card-title">${card.nazwa}</h3>
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Opis -->
                            ${descStr ? `<p class="item-card-description">${descStr}</p>` : ''}
                            
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                ${card.typ ? `<span class="badge badge-type">${card.typ.charAt(0).toUpperCase() + card.typ.slice(1)}</span>` : ''}
                                ${statusBadge}
                            </div>
                            
                            ${datesStr ? `<p style="font-size: 12px; color: #666; margin-top: 10px;">${datesStr}</p>` : ''}
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editMenuCard(${card.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateMenuCard(${card.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-status" onclick="showStatusMenu(event, ${card.id})">
                                    üìä Status
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteMenuCard(${card.id})">
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FLOATING STATUS MENU === 
        function showStatusMenu(event, cardId) {
            event.stopPropagation();
            
            const existing = document.getElementById('floatingStatusMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'floatingStatusMenu';
            menu.className = 'floating-status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${cardId}, 'robocza')">üìù Robocze</div>
                <div onclick="changeStatus(${cardId}, 'active')">‚úÖ Aktywne</div>
                <div onclick="changeStatus(${cardId}, 'archived')">üì¶ Archiwum</div>
            `;
            
            document.body.appendChild(menu);
            
            const buttonRect = event.target.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            let top, left;
            
            if (buttonRect.bottom + menuRect.height + 10 < viewportHeight) {
                top = buttonRect.bottom + 5;
            } else {
                top = buttonRect.top - menuRect.height - 5;
            }
            
            if (buttonRect.left + menuRect.width > viewportWidth) {
                left = buttonRect.right - menuRect.width;
            } else {
                left = buttonRect.left;
            }
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        async function changeStatus(cardId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/menu-cards/${cardId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                document.getElementById('floatingStatusMenu')?.remove();
                loadMenuCards();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zmiany statusu');
            }
        }

        // PodglƒÖd karty
        function viewMenuCard(cardId) {
            window.location.href = `menu-cards-view.html?id=${cardId}`;
        }

        // === CRUD OPERATIONS ===
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj kartƒô menu';
            document.getElementById('menuCardForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('menuCardModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('menuCardModal').style.display = 'none';
        }

        async function editMenuCard(id) {
            const card = allMenuCards.find(c => c.id === id);
            if (!card) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj kartƒô menu';
            document.getElementById('editId').value = card.id;
            document.getElementById('nazwa').value = card.nazwa || '';
            document.getElementById('typ').value = card.typ || 'sta≈Ça';
            document.getElementById('lokal').value = card.lokal || '';
            
            if (card.data_od) {
                document.getElementById('data_od').value = card.data_od.split('T')[0];
            }
            if (card.data_do) {
                document.getElementById('data_do').value = card.data_do.split('T')[0];
            }
            
            document.getElementById('menuCardModal').style.display = 'block';
        }

        async function saveMenuCard(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
    nazwa: document.getElementById('nazwa').value,
    typ: document.getElementById('typ').value,
    lokal: document.getElementById('lokal').value,
    status: 'active',
    data_od: document.getElementById('data_od').value || null,
    data_do: document.getElementById('data_do').value || null
};

console.log('Sending data:', data); // DODAJ Tƒò LINIƒò

try {
    const url = id ? `${API_URL}/api/menu-cards/${id}` : `${API_URL}/api/menu-cards`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
    const errorData = await response.json();
    console.error('Backend error:', errorData);
    throw new Error('B≈ÇƒÖd zapisu: ' + (errorData.error || response.statusText));
}
                
                alert(id ? 'Zapisano zmiany' : 'Dodano kartƒô menu');
                closeModal();
                loadMenuCards();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        async function duplicateMenuCard(id) {
            const card = allMenuCards.find(c => c.id === id);
            if (!card) return;
            
            if (!confirm(`Duplikowaƒá kartƒô "${card.nazwa}"?`)) return;
            
            const newCard = {
                nazwa: card.nazwa + ' (kopia)',
                typ: card.typ,
                lokal: card.lokal,
                data_od: card.data_od,
                data_do: card.data_do,
                status: 'active'
            };
            
            try {
                const response = await fetch(`${API_URL}/api/menu-cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newCard)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
                
                alert('Zduplikowano kartƒô menu (bez da≈Ñ)');
                loadMenuCards();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd duplikowania: ' + error.message);
            }
        }

        async function deleteMenuCard(id) {
            const card = allMenuCards.find(c => c.id === id);
            if (!card) return;
            
            if (!confirm(`Czy na pewno usunƒÖƒá "${card.nazwa}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/menu-cards/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                alert('Usuniƒôto kartƒô menu');
                loadMenuCards();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd usuwania: ' + error.message);
            }
        }

        // Zamykanie modala klikniƒôciem poza
        window.onclick = function(event) {
            const modal = document.getElementById('menuCardModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
