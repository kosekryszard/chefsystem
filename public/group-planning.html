<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chefsystent - Planowanie Posi≈Çk√≥w</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
    <style>
        body {
            background: linear-gradient(135deg, #0A1F44 0%, #1a3a6b 100%);
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .content { padding: 30px; }
        
        /* Header info grupy */
        .group-info-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
        }
        .info-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .info-item .value {
            font-size: 16px;
            color: #0A1F44;
            font-weight: 700;
        }
        
        /* Timeline dni */
        .days-timeline {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* Karta dnia */
        .day-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .day-card:hover {
            border-color: #D4AF37;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.15);
        }
        
        /* Header dnia */
        .day-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0A1F44 100%);
            padding: 20px;
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-add-meal {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-add-meal:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .day-date-info {
            text-align: right;
        }
        
        .day-date-large {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .day-name {
            font-size: 16px;
            opacity: 0.9;
            text-transform: capitalize;
        }
        
        * Sekcja posi≈Çk√≥w */
        .meals-section {
            padding: 20px;
        }
        
        /* Grid posi≈Çk√≥w */
        .meals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        /* Karta posi≈Çku */
        .meal-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }
        .meal-card:hover {
            border-color: #D4AF37;
            background: #fff;
        }
        .meal-card.has-dish {
            border-color: #28a745;
            background: #f0f8f4;
        }
        
        /* Typ posi≈Çku */
        .meal-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .meal-type-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .meal-time-input {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            color: #0A1F44;
            cursor: pointer;
        }
        
        .meal-time-input:hover {
            border-color: #D4AF37;
        }
        
        .meal-type-icon {
            font-size: 24px;
        }
        
        .meal-type-name {
            font-weight: 600;
            font-size: 16px;
            color: #0A1F44;
        }
        
        .btn-remove-meal-type {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s;
            padding: 5px;
        }
        
        .btn-remove-meal-type:hover {
            opacity: 1;
            transform: scale(1.2);
        }
        
        /* Wybrane danie */
        .selected-dish {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }
        .selected-dish .dish-name {
            font-weight: 600;
            color: #0A1F44;
            margin-bottom: 8px;
        }
        .selected-dish .portions {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .selected-dish input[type="number"] {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
        }
        
        /* Przyciski w meal-card */
        .meal-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-add {
            background: #28a745;
            color: white;
        }
        .btn-add:hover {
            background: #218838;
        }
        .btn-change {
            background: #17a2b8;
            color: white;
        }
        .btn-change:hover {
            background: #138496;
        }
        .btn-remove {
            background: #dc3545;
            color: white;
        }
        .btn-remove:hover {
            background: #c82333;
        }
        
        /* Placeholder gdy brak dania */
        .no-dish {
            color: #999;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
        }
        
        /* Sticky header z akcjami */
        .sticky-actions {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 0;
            border-bottom: 2px solid #e0e0e0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Statystyki */
        .stats-bar {
            background: #e3f2fd;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            gap: 30px;
            align-items: center;
            margin-top: 20px;
        }
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        .stat-item .label {
            font-size: 12px;
            color: #666;
        }
        .stat-item .value {
            font-size: 18px;
            font-weight: 700;
            color: #0A1F44;
        }
        /* Drag & Drop styles */
        .selected-dish {
            cursor: move;
            transition: all 0.2s;
        }
        .selected-dish.dragging {
            opacity: 0.4;
        }
        .selected-dish.drag-over {
            border-top: 3px solid #D4AF37;
            padding-top: 3px;
        }
        .drag-handle {
            cursor: grab;
            color: #999;
            font-size: 16px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #D4AF37;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

/* Responsywny layout da≈Ñ */
.dish-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .dish-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .dish-name {
            font-weight: 600;
            color: #0A1F44;
            flex: 1;
        }
        
        .dish-portions {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .portions-input {
            width: 70px;
            padding: 5px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-align: center;
        }
        
        .dish-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        /* Na wiƒôkszych ekranach - jeden wiersz */
        @media (min-width: 768px) {
            .dish-row {
                flex-direction: row;
                align-items: center;
            }
            
            .dish-info {
                flex: 1;
            }
            
            .dish-actions {
                flex-wrap: nowrap;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Planowanie Posi≈Çk√≥w</p>
            
            <nav>
                <a href="index.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">‚Üê Grupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Loading state -->
            <div id="loadingState" class="loading">
                ≈Åadowanie danych grupy...
            </div>

            <!-- Main content (ukryte na starcie) -->
            <div id="mainContent" style="display: none;">
                
                <!-- Info o grupie -->
                <div class="group-info-header">
                    <div class="info-item">
                        <label>Nazwa grupy</label>
                        <div class="value" id="groupName">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Organizator</label>
                        <div class="value" id="groupOrganizer">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Liczba os√≥b</label>
                        <div class="value" id="groupPeople">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Wiek grupy</label>
                        <div class="value" id="groupAge">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <label>Okres</label>
                        <div class="value" id="groupPeriod">‚Äî</div>
                    </div>
                </div>

                <!-- Sticky akcje -->
                <div class="sticky-actions">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn" onclick="window.location.href='groups.html'" 
                                style="background: #6c757d; color: white;">
                            ‚Üê Wr√≥ƒá do grup
                        </button>
                        <h2 style="margin: 0;">Jad≈Çospis grupy</h2>
                    </div>
                    <button class="btn btn-success" onclick="saveAllMeals()">
                        üíæ Zapisz wszystkie zmiany
                    </button>
                </div>

                <!-- Timeline dni -->
                <div class="days-timeline" id="daysTimeline">
                    <!-- Dni bƒôdƒÖ generowane dynamicznie przez JS -->
                </div>

                <!-- Statystyki -->
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="label">Dni w jad≈Çospisie</span>
                        <span class="value" id="statDays">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">Zaplanowane posi≈Çki</span>
                        <span class="value" id="statPlanned">0 / 0</span>
                    </div>
                    <div class="stat-item">
                        <span class="label">Postƒôp</span>
                        <span class="value" id="statProgress">0%</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal: Wyb√≥r dania -->
    <div id="dishModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Wybierz danie</h2>
                <span class="close" onclick="closeDishModal()">&times;</span>
            </div>

            <div style="padding: 20px;">
                <!-- Wyszukiwanie -->
                <input type="text" id="dishSearch" placeholder="üîç Szukaj dania..." 
                       style="width: 100%; padding: 10px; margin-bottom: 20px; border: 2px solid #e0e0e0; border-radius: 8px;">

                <!-- Lista da≈Ñ -->
                <div id="dishesList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Dania bƒôdƒÖ generowane przez JS -->
                </div>
            </div>
        </div>
    </div>

<!-- Modal dodawania typu posi≈Çku -->
<div id="addMealTypeModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Dodaj typ posi≈Çku</h2>
            <button class="btn-close" onclick="closeAddMealTypeModal()">‚úï</button>
        </div>
        
        <div id="mealTypesList" style="display: grid; gap: 10px; padding: 20px;">
            <!-- Dynamicznie generowana lista -->
        </div>
    </div>
</div>

<!-- Modal kopiowania dania -->
<div id="copyDishModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h2>Kopiuj danie do innego dnia</h2>
            <button class="btn-close" onclick="closeCopyDishModal()">‚úï</button>
        </div>
        
        <div style="padding: 20px;">
            <p id="copyDishInfo" style="margin-bottom: 15px; font-weight: 600;"></p>
            
            <label style="display: block; margin-bottom: 10px; font-weight: 600;">
                Wybierz dzie≈Ñ docelowy:
            </label>
            
            <div id="targetDaysList" style="display: grid; gap: 10px;">
                <!-- Dynamicznie generowana lista dni -->
            </div>
        </div>
    </div>
</div>

    <script>
        // ========== ZMIENNE GLOBALNE ==========
        let groupId = null;
        let groupData = null;
        let mealsData = [];
        let allDishes = [];
        let currentEditingMeal = null;
        let mealTypeDefaults = {};  // DODANE - domy≈õlne godziny typ√≥w posi≈Çk√≥w
        let currentAddMealDay = null;  // DODANE - dzie≈Ñ dla modalu dodawania typu
        let copyDishData = null;  // DODANE - dane kopiowanego dania

        // ========== INICJALIZACJA ==========
        document.addEventListener('DOMContentLoaded', async () => {
            // Pobierz ID grupy z URL
            const urlParams = new URLSearchParams(window.location.search);
            groupId = urlParams.get('id');
            
            if (!groupId) {
                alert('‚ùå Brak ID grupy w URL!');
                window.location.href = 'groups.html';
                return;
            }
            
            await loadGroupData();
            await loadDishes();
            await loadMealTypeDefaults();  // DODANE
            await loadExistingMeals();
            generateDaysTimeline();
            updateStats();
            
            // Poka≈º g≈Ç√≥wnƒÖ zawarto≈õƒá
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        });

        // ========== ≈ÅADOWANIE DANYCH ==========
        
        async function loadGroupData() {
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania grupy');
                
                groupData = await response.json();
                console.log('üìä Za≈Çadowano groupData:', groupData);
                console.log('üìä Pola:', Object.keys(groupData));
                
                // Wype≈Çnij header
                document.getElementById('groupName').textContent = groupData.nazwa;
                document.getElementById('groupOrganizer').textContent = groupData.organizator_nazwa || '‚Äî';
                
                const totalPeople = (groupData.liczba_uczestnikow || 0) + 
                                   (groupData.liczba_opiekunow || 0) + 
                                   (groupData.liczba_pilotow || 0) + 
                                   (groupData.liczba_kierowcow || 0) + 
                                   (groupData.liczba_kadry || 0);
                document.getElementById('groupPeople').textContent = `${totalPeople} os√≥b`;
                document.getElementById('groupAge').textContent = groupData.wiek_grupy || '‚Äî';
                
                const dateFirst = new Date(groupData.data_pierwszy_posilek).toLocaleDateString('pl-PL');
                const dateLast = new Date(groupData.data_ostatni_posilek).toLocaleDateString('pl-PL');
                document.getElementById('groupPeriod').textContent = `${dateFirst} ‚Äì ${dateLast}`;
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd ≈Çadowania danych grupy');
            }
        }
        
        async function loadDishes() {
            try {
                const response = await fetch('/api/dishes');
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania da≈Ñ');
                
                allDishes = await response.json();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd ≈Çadowania da≈Ñ');
            }
        }
        // Za≈Çaduj domy≈õlne godziny typ√≥w posi≈Çk√≥w dla grupy
        async function loadMealTypeDefaults() {
            try {
                const response = await fetch(`/api/groups/${groupId}/meal-type-defaults`);
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania domy≈õlnych godzin');
                
                const defaults = await response.json();
                
                // Konwertuj do obiektu { typ_posilku: godzina }
                mealTypeDefaults = {};
                defaults.forEach(d => {
                    mealTypeDefaults[d.typ_posilku] = d.domyslna_godzina;
                });
                
                console.log('Za≈Çadowano domy≈õlne godziny:', mealTypeDefaults);
                
            } catch (error) {
                console.error('Error loading meal type defaults:', error);
                // Ustaw domy≈õlne warto≈õci
                mealTypeDefaults = {
                    'sniadanie': '08:00',
                    'ii_sniadanie': '10:00',
                    'suchy_prowiant': '12:00',
                    'obiad': '14:00',
                    'powieczorek': '16:00',
                    'kolacja': '18:00',
                    'obiadokolacja': '15:00',
                    'ognisko': '20:00'
                };
            }
        }

        async function loadExistingMeals() {
            try {
                const response = await fetch(`/api/groups/${groupId}/meals`);
                if (!response.ok) throw new Error('B≈ÇƒÖd pobierania posi≈Çk√≥w');
                
                const meals = await response.json();
                
                // Przekszta≈Çƒá dane - grupuj po (dzien, typ_posilku)
                mealsData = meals.map(m => ({
                    id: m.id,
                    dayNumber: m.dzien_numer,
                    date: m.data,
                    mealType: m.typ_posilku,
                    dishId: m.dish_id,
                    portions: m.liczba_porcji,
                    uwagi: m.uwagi,
                    kolejnosc: m.kolejnosc || 1,
                    godzina: m.godzina || '12:00'  // DODANE
                }));
                
            } catch (error) {
                console.error('Error:', error);
                // Nie pokazuj alertu - mo≈ºe po prostu nie ma jeszcze posi≈Çk√≥w
            }
        }

        // ========== GENEROWANIE TIMELINE ==========
        
        function generateDaysTimeline() {
            const timeline = document.getElementById('daysTimeline');
            timeline.innerHTML = '';
            
            // Sprawd≈∫ czy dane grupy zosta≈Çy za≈Çadowane
            if (!groupData || !groupData.data_pierwszy_posilek) {
                timeline.innerHTML = '<div class="loading">≈Åadowanie danych grupy...</div>';
                return;
            }
            
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const dateLast = new Date(groupData.data_ostatni_posilek);
            
            let currentDate = new Date(dateFirst);
            let dayNumber = 1;
            
            while (currentDate <= dateLast) {
                const dayCard = createDayCard(dayNumber, new Date(currentDate));
                timeline.appendChild(dayCard);
                
                // Nastƒôpny dzie≈Ñ
                currentDate.setDate(currentDate.getDate() + 1);
                dayNumber++;
            }
            
            // Aktualizuj statystykƒô dni
            document.getElementById('statDays').textContent = dayNumber - 1;
        }
        
        function createDayCard(dayNumber, date) {
            const card = document.createElement('div');
            card.className = 'day-card';
            card.id = `day-${dayNumber}`;
            
            const dayName = date.toLocaleDateString('pl-PL', { weekday: 'long' });
            const dateStr = date.toLocaleDateString('pl-PL');
            
            card.innerHTML = `
                <div class="day-header">
                    <button class="btn-add-meal" onclick="openAddMealTypeModal(${dayNumber})">
                        ‚ûï Dodaj posi≈Çek
                    </button>
                    <div class="day-date-info">
                        <div class="day-date-large">${dateStr}</div>
                        <div class="day-name">${dayName}</div>
                    </div>
                </div>
                <div class="meals-section">
                    <div class="meals-grid" id="meals-day-${dayNumber}">
                        ${generateMealCardsForDay(dayNumber, date)}
                    </div>
                </div>
            `;
            
            return card;
        }
        
        function generateMealCardsForDay(dayNumber, date) {
            // Pobierz unikalne typy posi≈Çk√≥w dla tego dnia z mealsData
            const dayMeals = mealsData.filter(m => m.dayNumber === dayNumber);
            const mealTypes = [...new Set(dayMeals.map(m => m.mealType))];
            
            // Je≈õli nie ma ≈ºadnych typ√≥w w tym dniu - nie pokazuj nic
            // (u≈ºytkownik u≈ºyje przycisku "Dodaj posi≈Çek")
            if (mealTypes.length === 0) {
                return '<div style="text-align: center; padding: 40px; color: #999;">Brak posi≈Çk√≥w. Kliknij "‚ûï Dodaj posi≈Çek" aby dodaƒá.</div>';
            }
            
            const mealIcons = {
                'sniadanie': 'üç≥',
                'ii_sniadanie': 'ü•™',
                'suchy_prowiant': 'ü•°',
                'obiad': 'üçΩÔ∏è',
                'powieczorek': 'üßÅ',
                'kolacja': 'üç≤',
                'obiadokolacja': 'üçõ',
                'ognisko': 'üî•'
            };
            
            const mealNames = {
                'sniadanie': '≈öniadanie',
                'ii_sniadanie': 'II ≈öniadanie',
                'suchy_prowiant': 'Suchy prowiant',
                'obiad': 'Obiad',
                'powieczorek': 'Powieczorek',
                'kolacja': 'Kolacja',
                'obiadokolacja': 'Obiadokolacja',
                'ognisko': 'Ognisko'
            };
            
            // Sortuj typy posi≈Çk√≥w po godzinie
            const mealTypesWithTime = mealTypes.map(mealType => {
                // Znajd≈∫ pierwszƒÖ godzinƒô dla tego typu
                const mealsOfType = mealsData.filter(m => 
                    m.dayNumber === dayNumber && m.mealType === mealType
                );
                
                const time = mealsOfType.length > 0 && mealsOfType[0].godzina
                    ? mealsOfType[0].godzina
                    : (mealTypeDefaults[mealType] || '12:00');
                
                return { mealType, time };
            });
            
            // Sortuj po godzinie
            mealTypesWithTime.sort((a, b) => a.time.localeCompare(b.time));
            
            return mealTypesWithTime.map(({ mealType }) => {
                // Znajd≈∫ WSZYSTKIE dania dla tego posi≈Çku (mo≈ºe byƒá wiele)
                const existingMeals = mealsData
                    .filter(m => m.dayNumber === dayNumber && m.mealType === mealType)
                    .sort((a, b) => (a.kolejnosc || 1) - (b.kolejnosc || 1)); // SORTUJ PO KOLEJNO≈öCI
                
                return createMealCard(dayNumber, date, mealType, mealIcons[mealType], mealNames[mealType], existingMeals);
            }).join('');
        }
        
        function createMealCard(dayNumber, date, mealType, icon, name, existingMeals) {
            // existingMeals to teraz TABLICA da≈Ñ dla tego posi≈Çku
            const hasDishes = existingMeals && existingMeals.length > 0;
            const cardClass = hasDishes ? 'has-dish' : '';
            
            // Pobierz godzinƒô - z pierwszego dania lub domy≈õlna
            const mealTime = hasDishes && existingMeals[0].godzina 
                ? existingMeals[0].godzina 
                : (mealTypeDefaults[mealType] || '12:00');
            
            let dishesHTML = '';
            
            if (hasDishes) {
                // Filtruj placeholdery (bez da≈Ñ)
                const realMeals = existingMeals.filter(m => m.dishId !== null && !m.isPlaceholder);
                
                if (realMeals.length === 0) {
                    // Tylko placeholdery - poka≈º jako puste
                    dishesHTML = `
                        <div class="no-dish">Nie wybrano dania</div>
                        <div class="meal-actions">
                            <button class="btn-small btn-add" 
                                    onclick="openDishSelector(${dayNumber}, '${mealType}', 1)">
                                ‚ûï Dodaj danie
                            </button>
                        </div>
                    `;
                } else {
                    // Poka≈º listƒô prawdziwych da≈Ñ
                    dishesHTML = realMeals.map((meal, idx) => {
                        const dish = allDishes.find(d => d.id === meal.dishId);
                        const dishName = dish ? dish.nazwa : 'Nieznane danie';
                        
                        return `
                            <div class="selected-dish" 
                                 draggable="true"
                                 data-meal-id="${meal.id || 'temp-' + idx}"
                                 data-day="${dayNumber}"
                                 data-meal-type="${mealType}"
                                 data-dish-id="${meal.dishId}"
                                 style="margin-top: ${idx > 0 ? '10px' : '0'};">
                                <div class="dish-row">
                                    <div class="dish-info">
                                        <div class="dish-name">${dishName}</div>
                                        <div class="dish-portions">
                                            <input type="number" min="1" value="${meal.portions}" 
                                                   class="portions-input"
                                                   onchange="updatePortions(${dayNumber}, '${mealType}', ${meal.id}, this.value)">
                                            <span style="font-size: 12px; color: #666;">porcji</span>
                                        </div>
                                    </div>
                                    <div class="dish-actions">
                                        ${idx > 0 ? `
                                            <button class="btn-small btn-change" 
                                                    onclick="moveUp(${dayNumber}, '${mealType}', ${idx})"
                                                    title="Przesu≈Ñ w g√≥rƒô">
                                                ‚Üë
                                            </button>
                                        ` : '<span style="width: 32px;"></span>'}
                                        ${idx < realMeals.length - 1 ? `
                                            <button class="btn-small btn-change" 
                                                    onclick="moveDown(${dayNumber}, '${mealType}', ${idx})"
                                                    title="Przesu≈Ñ w d√≥≈Ç">
                                                ‚Üì
                                            </button>
                                        ` : '<span style="width: 32px;"></span>'}
                                        <button class="btn-small btn-copy" 
                                                onclick="openCopyDishModal(${dayNumber}, '${mealType}', ${meal.dishId}, ${meal.portions})"
                                                title="Kopiuj to danie do innego dnia"
                                                style="background: #17a2b8; color: white;">
                                            üìã
                                        </button>
                                        <button class="btn-small btn-move" 
                                                onclick="openMoveDishModal(${dayNumber}, '${mealType}', ${meal.dishId}, ${meal.portions})"
                                                title="Przenie≈õ to danie do innego dnia"
                                                style="background: #ff9800; color: white;">
                                            ‚úÇÔ∏è
                                        </button>
                                        <button class="btn-small btn-remove" 
                                                onclick="removeDish(${dayNumber}, '${mealType}', ${meal.id})"
                                                title="Usu≈Ñ to danie">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Przycisk "Dodaj kolejne danie"
                    dishesHTML += `
                        <div style="margin-top: 10px;">
                            <button class="btn-small btn-add" 
                                    onclick="openDishSelector(${dayNumber}, '${mealType}', ${realMeals.length + 1})"
                                    style="width: 100%;">
                                ‚ûï Dodaj kolejne danie
                            </button>
                        </div>
                    `;
                }
            } else {
                dishesHTML = `
                    <div class="no-dish">Nie wybrano dania</div>
                    <div class="meal-actions">
                        <button class="btn-small btn-add" 
                                onclick="openDishSelector(${dayNumber}, '${mealType}', 1)">
                            ‚ûï Dodaj danie
                        </button>
                    </div>
                `;
            }
            
            return `
                <div class="meal-card ${cardClass}">
                    <div class="meal-type-header">
                        <div class="meal-type-left">
                            <input type="time" 
                                   value="${mealTime}" 
                                   step="900"
                                   class="meal-time-input"
                                   onchange="updateMealTime(${dayNumber}, '${mealType}', this.value)"
                                   title="Godzina posi≈Çku (co 15 min)">
                            <span class="meal-type-icon">${icon}</span>
                            <span class="meal-type-name">${name}</span>
                        </div>
                        <button class="btn-remove-meal-type" 
                                onclick="removeMealType(${dayNumber}, '${mealType}')"
                                title="Usu≈Ñ ten typ posi≈Çku z dnia">
                            ‚ùå
                        </button>
                    </div>
                    <div class="meal-content">
                        ${dishesHTML}
                    </div>
                </div>
            `;
        }

    // ========== AKCJE NA POSI≈ÅKACH ==========
        
    function openDishSelector(dayNumber, mealType, kolejnosc) {
        currentEditingMeal = { dayNumber, mealType, kolejnosc };
            
            // Poka≈º modal
            document.getElementById('dishModal').style.display = 'flex';
            
            // Wygeneruj listƒô da≈Ñ
            renderDishesList(allDishes);
            
            // Wyczy≈õƒá wyszukiwanie
            document.getElementById('dishSearch').value = '';
            document.getElementById('dishSearch').focus();
        }
        
        function renderDishesList(dishes) {
            const container = document.getElementById('dishesList');
            
            if (dishes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Brak da≈Ñ</p>';
                return;
            }
            
            container.innerHTML = dishes.map(dish => `
                <div class="dish-item" onclick="selectDish(${dish.id})" 
                     style="padding: 15px; border-bottom: 1px solid #e0e0e0; cursor: pointer; transition: all 0.2s;">
                    <div style="font-weight: 600; color: #0A1F44; margin-bottom: 5px;">
                        ${dish.nazwa}
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        ${dish.typ || 'Brak typu'} ‚Ä¢ ${dish.cena ? dish.cena + ' z≈Ç' : 'Brak ceny'}
                    </div>
                </div>
            `).join('');
            
            // Hover effect
            const items = container.querySelectorAll('.dish-item');
            items.forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
            });
        }
        
        function selectDish(dishId) {
            if (!currentEditingMeal) return;
            
            const { dayNumber, mealType, kolejnosc } = currentEditingMeal;
            
            // Znajd≈∫ datƒô dla tego dnia
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const mealDate = new Date(dateFirst);
            mealDate.setDate(mealDate.getDate() + (dayNumber - 1));
            
            // Domy≈õlna liczba porcji = suma os√≥b
            const defaultPortions = (groupData.liczba_uczestnikow || 0) + 
                                   (groupData.liczba_opiekunow || 0) + 
                                   (groupData.liczba_pilotow || 0) + 
                                   (groupData.liczba_kierowcow || 0) + 
                                   (groupData.liczba_kadry || 0);
            
// Pobierz godzinƒô - z istniejƒÖcych da≈Ñ tego typu lub domy≈õlnƒÖ
const existingMealsOfType = mealsData.filter(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            );
            const mealTime = existingMealsOfType.length > 0 && existingMealsOfType[0].godzina
                ? existingMealsOfType[0].godzina
                : (mealTypeDefaults[mealType] || '12:00');
            
            // Dodaj nowe danie (nie sprawdzamy czy istnieje - pozwalamy na wiele)
            mealsData.push({
                id: null, // bƒôdzie nadane przez backend
                dayNumber,
                date: mealDate.toISOString().split('T')[0],
                mealType,
                dishId,
                portions: defaultPortions,
                uwagi: null,
                kolejnosc: kolejnosc || 1,
                godzina: mealTime  // DODANE
            });
            
            // Od≈õwie≈º wy≈õwietlanie
            refreshDayMeals(dayNumber);
            updateStats();
            
            // Zamknij modal
            closeDishModal();
        }
            
            // Znajd≈∫ datƒô dla tego dnia
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const mealDate = new Date(dateFirst);
            mealDate.setDate(mealDate.getDate() + (dayNumber - 1));
            
            // Domy≈õlna liczba porcji = suma os√≥b
            const defaultPortions = (groupData.liczba_uczestnikow || 0) + 
                                   (groupData.liczba_opiekunow || 0) + 
                                   (groupData.liczba_pilotow || 0) + 
                                   (groupData.liczba_kierowcow || 0) + 
                                   (groupData.liczba_kadry || 0);
            
            // Sprawd≈∫ czy posi≈Çek ju≈º istnieje
            const existingIndex = mealsData.findIndex(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            );
            
            if (existingIndex >= 0) {
                // Aktualizuj istniejƒÖcy
                mealsData[existingIndex].dishId = dishId;
            } else {
                // Dodaj nowy
                mealsData.push({
                    id: null, // bƒôdzie nadane przez backend
                    dayNumber,
                    date: mealDate.toISOString().split('T')[0],
                    mealType,
                    dishId,
                    portions: defaultPortions,
                    uwagi: null
                });
            }
            
            // Od≈õwie≈º wy≈õwietlanie
            refreshDayMeals(dayNumber);
            updateStats();
            
            // Zamknij modal
            closeDishModal();
        
        function updatePortions(dayNumber, mealType, mealId, newPortions) {
    const meal = mealsData.find(m => m.id === mealId);
    
    if (meal) {
        meal.portions = parseInt(newPortions) || 0;
    }
}
        
        function removeDish(dayNumber, mealType, mealId) {
            if (!confirm('Czy na pewno usunƒÖƒá to danie?')) return;
            
            const index = mealsData.findIndex(m => m.id === mealId);
            
            if (index >= 0) {
                mealsData.splice(index, 1);
            }
            
            refreshDayMeals(dayNumber);
            updateStats();
        }
        
// Aktualizuj godzinƒô posi≈Çku
function updateMealTime(dayNumber, mealType, newTime) {
            // Znajd≈∫ wszystkie dania tego typu posi≈Çku w tym dniu
            const meals = mealsData.filter(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            );
            
            // Ustaw nowƒÖ godzinƒô dla wszystkich
            meals.forEach(meal => {
                meal.godzina = newTime;
            });
            
            // Od≈õwie≈º widok (z sortowaniem)
            refreshDayMeals(dayNumber);
        }
        
        // Usu≈Ñ ca≈Çy typ posi≈Çku z dnia
        function removeMealType(dayNumber, mealType) {
            const mealNames = {
                'sniadanie': '≈öniadanie',
                'ii_sniadanie': 'II ≈öniadanie',
                'suchy_prowiant': 'Suchy prowiant',
                'obiad': 'Obiad',
                'powieczorek': 'Powieczorek',
                'kolacja': 'Kolacja',
                'obiadokolacja': 'Obiadokolacja',
                'ognisko': 'Ognisko'
            };
            
            const mealName = mealNames[mealType] || mealType;
            
            if (!confirm(`Czy na pewno usunƒÖƒá ${mealName} z tego dnia?\n\nSpowoduje to usuniƒôcie wszystkich da≈Ñ tego posi≈Çku.`)) {
                return;
            }
            
            // Usu≈Ñ wszystkie dania tego typu z dnia
            mealsData = mealsData.filter(m => 
                !(m.dayNumber === dayNumber && m.mealType === mealType)
            );
            
            refreshDayMeals(dayNumber);
            updateStats();
        }

// Otw√≥rz modal dodawania typu posi≈Çku do dnia
// Zmienna do ≈õledzenia bie≈ºƒÖcego dnia
currentAddMealDay = null;
        
        // Otw√≥rz modal dodawania typu posi≈Çku do dnia
        function openAddMealTypeModal(dayNumber) {
            currentAddMealDay = dayNumber;
            
            // Pobierz typy posi≈Çk√≥w ju≈º dodane w tym dniu
            const existingTypes = [...new Set(mealsData
                .filter(m => m.dayNumber === dayNumber)
                .map(m => m.mealType)
            )];
            
            // Wszystkie dostƒôpne typy
            const allTypes = [
                { id: 'sniadanie', name: '≈öniadanie', icon: 'üç≥' },
                { id: 'ii_sniadanie', name: 'II ≈öniadanie', icon: 'ü•™' },
                { id: 'suchy_prowiant', name: 'Suchy prowiant', icon: 'ü•°' },
                { id: 'obiad', name: 'Obiad', icon: 'üçΩÔ∏è' },
                { id: 'powieczorek', name: 'Powieczorek', icon: 'üßÅ' },
                { id: 'kolacja', name: 'Kolacja', icon: 'üç≤' },
                { id: 'obiadokolacja', name: 'Obiadokolacja', icon: 'üçõ' },
                { id: 'ognisko', name: 'Ognisko', icon: 'üî•' }
            ];
            
            // Typy kt√≥re mo≈ºna dodaƒá (nie ma ich jeszcze w tym dniu)
            const availableTypes = allTypes.filter(t => !existingTypes.includes(t.id));
            
            if (availableTypes.length === 0) {
                alert('‚úÖ Wszystkie typy posi≈Çk√≥w sƒÖ ju≈º dodane do tego dnia!');
                return;
            }
            
            // Generuj przyciski
            const container = document.getElementById('mealTypesList');
            container.innerHTML = availableTypes.map(t => `
                <button class="meal-type-option" onclick="addMealTypeToDay(${dayNumber}, '${t.id}')"
                        style="display: flex; align-items: center; gap: 15px; padding: 15px 20px; 
                               border: 2px solid #e9ecef; border-radius: 8px; background: white;
                               cursor: pointer; transition: all 0.2s; font-size: 16px;">
                    <span style="font-size: 32px;">${t.icon}</span>
                    <span style="font-weight: 600; color: #0A1F44;">${t.name}</span>
                </button>
            `).join('');
            
            // Dodaj hover effect przez CSS
            const style = document.createElement('style');
            style.textContent = `
                .meal-type-option:hover {
                    border-color: #D4AF37;
                    background: #fffbf0;
                    transform: translateX(5px);
                }
            `;
            document.head.appendChild(style);
            
            // Poka≈º modal
            document.getElementById('addMealTypeModal').style.display = 'flex';
        }
        
        function closeAddMealTypeModal() {
            document.getElementById('addMealTypeModal').style.display = 'none';
            currentAddMealDay = null;
        }
        
        // Otw√≥rz modal kopiowania dania
        function openCopyDishModal(sourceDayNumber, mealType, dishId, portions) {
            console.log('üîç Debug - groupData:', groupData);
            console.log('üîç Debug - groupData.liczba_dni:', groupData?.liczba_dni);
            console.log('üîç Debug - groupData.data_pierwszy_posilek:', groupData?.data_pierwszy_posilek);
            
            if (!groupData) {
                alert('‚ùå B≈ÇƒÖd: Dane grupy nie sƒÖ za≈Çadowane');
                return;
            }
            
            const dish = allDishes.find(d => d.id === dishId);
            const dishName = dish ? dish.nazwa : 'Nieznane danie';
            
            // Zapisz dane do skopiowania
            copyDishData = {
                sourceDayNumber,
                mealType,
                dishId,
                portions
            };
            
            // Poka≈º info o daniu
            document.getElementById('copyDishInfo').textContent = 
                `Danie: ${dishName} (${portions} porcji)`;
            
            // Wygeneruj listƒô dni (wszystkie dni grupy OPR√ìCZ ≈∫r√≥d≈Çowego)
            const container = document.getElementById('targetDaysList');
            const dayButtons = [];
            
            // Oblicz liczbƒô dni z dat
const dateFirst = new Date(groupData.data_pierwszy_posilek);
const dateLast = new Date(groupData.data_ostatni_posilek);
const diffTime = Math.abs(dateLast - dateFirst);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

for (let day = 1; day <= diffDays; day++) {
                if (day === sourceDayNumber) continue; // Pomi≈Ñ ≈∫r√≥d≈Çowy dzie≈Ñ
                
                const dateFirst = new Date(groupData.data_pierwszy_posilek);
                const currentDate = new Date(dateFirst);
                currentDate.setDate(currentDate.getDate() + (day - 1));
                
                const dayName = ['Niedziela', 'Poniedzia≈Çek', 'Wtorek', '≈öroda', 
                                 'Czwartek', 'PiƒÖtek', 'Sobota'][currentDate.getDay()];
                const dateStr = currentDate.toLocaleDateString('pl-PL');
                
                dayButtons.push(`
                    <button class="day-select-btn" 
                            onclick="copyDishToDay(${day})"
                            style="display: flex; justify-content: space-between; align-items: center;
                                   padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 8px;
                                   background: white; cursor: pointer; transition: all 0.2s;">
                        <div>
                            <div style="font-weight: 600; color: #0A1F44;">Dzie≈Ñ ${day}</div>
                            <div style="font-size: 14px; color: #666;">${dayName}, ${dateStr}</div>
                        </div>
                        <div style="font-size: 24px;">‚Üí</div>
                    </button>
                `);
            }
            
            container.innerHTML = dayButtons.join('');
            
            // Dodaj hover effect
            const style = document.createElement('style');
            style.textContent = `
                .day-select-btn:hover {
                    border-color: #D4AF37;
                    background: #fffbf0;
                    transform: translateX(5px);
                }
            `;
            document.head.appendChild(style);
            
            // Poka≈º modal
            document.getElementById('copyDishModal').style.display = 'flex';
        }
        
        function closeCopyDishModal() {
            document.getElementById('copyDishModal').style.display = 'none';
            copyDishData = null;
        }
        
        // Skopiuj danie do wybranego dnia
        function copyDishToDay(targetDayNumber) {
            if (!copyDishData) return;
            
            const { mealType, dishId, portions } = copyDishData;
            
            // Znajd≈∫ datƒô dla docelowego dnia
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const targetDate = new Date(dateFirst);
            targetDate.setDate(targetDate.getDate() + (targetDayNumber - 1));
            
            // Pobierz godzinƒô - z istniejƒÖcych da≈Ñ tego typu w docelowym dniu lub domy≈õlnƒÖ
            const existingMealsOfType = mealsData.filter(m => 
                m.dayNumber === targetDayNumber && m.mealType === mealType
            );
            const mealTime = existingMealsOfType.length > 0 && existingMealsOfType[0].godzina
                ? existingMealsOfType[0].godzina
                : (mealTypeDefaults[mealType] || '12:00');
            
            // Znajd≈∫ najwy≈ºszƒÖ kolejno≈õƒá dla tego typu w docelowym dniu
            const maxKolejnosc = Math.max(
                0,
                ...existingMealsOfType.map(m => m.kolejnosc || 0)
            );
            
            // Dodaj skopiowane danie
            mealsData.push({
                id: null,
                dayNumber: targetDayNumber,
                date: targetDate.toISOString().split('T')[0],
                mealType,
                dishId,
                portions,
                uwagi: null,
                kolejnosc: maxKolejnosc + 1,
                godzina: mealTime
            });
            
            // Od≈õwie≈º widok docelowego dnia
            refreshDayMeals(targetDayNumber);
            
            // Zamknij modal
            closeCopyDishModal();
            
            // Poka≈º komunikat
            alert(`‚úÖ Skopiowano danie do dnia ${targetDayNumber}`);
        }
// Otw√≥rz modal przenoszenia dania (podobny do kopiowania, ale usuwa ze ≈∫r√≥d≈Ça)
function openMoveDishModal(sourceDayNumber, mealType, dishId, portions) {
            if (!groupData) {
                alert('‚ùå B≈ÇƒÖd: Dane grupy nie sƒÖ za≈Çadowane');
                return;
            }
            
            const dish = allDishes.find(d => d.id === dishId);
            const dishName = dish ? dish.nazwa : 'Nieznane danie';
            
            // Zapisz dane do przeniesienia
            copyDishData = {
                sourceDayNumber,
                mealType,
                dishId,
                portions,
                isMove: true  // FLAGA - to jest przenoszenie
            };
            
            // Poka≈º info o daniu
            document.getElementById('copyDishInfo').textContent = 
                `Przenie≈õ danie: ${dishName} (${portions} porcji)`;
            
            // Wygeneruj listƒô dni (wszystkie dni grupy OPR√ìCZ ≈∫r√≥d≈Çowego)
            const container = document.getElementById('targetDaysList');
            const dayButtons = [];
            
            // Oblicz liczbƒô dni z dat
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const dateLast = new Date(groupData.data_ostatni_posilek);
            const diffTime = Math.abs(dateLast - dateFirst);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            for (let day = 1; day <= diffDays; day++) {
                if (day === sourceDayNumber) continue; // Pomi≈Ñ ≈∫r√≥d≈Çowy dzie≈Ñ
                
                const currentDate = new Date(dateFirst);
                currentDate.setDate(currentDate.getDate() + (day - 1));
                
                const dayName = ['Niedziela', 'Poniedzia≈Çek', 'Wtorek', '≈öroda', 
                                 'Czwartek', 'PiƒÖtek', 'Sobota'][currentDate.getDay()];
                const dateStr = currentDate.toLocaleDateString('pl-PL');
                
                dayButtons.push(`
                    <button class="day-select-btn" 
                            onclick="moveDishToDay(${day})"
                            style="display: flex; justify-content: space-between; align-items: center;
                                   padding: 15px 20px; border: 2px solid #e9ecef; border-radius: 8px;
                                   background: white; cursor: pointer; transition: all 0.2s;">
                        <div>
                            <div style="font-weight: 600; color: #0A1F44;">Dzie≈Ñ ${day}</div>
                            <div style="font-size: 14px; color: #666;">${dayName}, ${dateStr}</div>
                        </div>
                        <div style="font-size: 24px;">‚úÇÔ∏è</div>
                    </button>
                `);
            }
            
            container.innerHTML = dayButtons.join('');
            
            // Poka≈º modal
            document.getElementById('copyDishModal').style.display = 'flex';
        }
        
        // Przenie≈õ danie do wybranego dnia (kopiuj + usu≈Ñ ze ≈∫r√≥d≈Ça)
        function moveDishToDay(targetDayNumber) {
            if (!copyDishData) return;
            
            const { sourceDayNumber, mealType, dishId, portions } = copyDishData;
            
            // Znajd≈∫ datƒô dla docelowego dnia
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const targetDate = new Date(dateFirst);
            targetDate.setDate(targetDate.getDate() + (targetDayNumber - 1));
            
            // Pobierz godzinƒô
            const existingMealsOfType = mealsData.filter(m => 
                m.dayNumber === targetDayNumber && m.mealType === mealType
            );
            const mealTime = existingMealsOfType.length > 0 && existingMealsOfType[0].godzina
                ? existingMealsOfType[0].godzina
                : (mealTypeDefaults[mealType] || '12:00');
            
            // Znajd≈∫ najwy≈ºszƒÖ kolejno≈õƒá
            const maxKolejnosc = Math.max(
                0,
                ...existingMealsOfType.map(m => m.kolejnosc || 0)
            );
            
            // Dodaj do docelowego dnia
            mealsData.push({
                id: null,
                dayNumber: targetDayNumber,
                date: targetDate.toISOString().split('T')[0],
                mealType,
                dishId,
                portions,
                uwagi: null,
                kolejnosc: maxKolejnosc + 1,
                godzina: mealTime
            });
            
            // USU≈É ze ≈∫r√≥d≈Çowego dnia (tylko pierwsze wystƒÖpienie tego dania)
            const sourceIndex = mealsData.findIndex(m => 
                m.dayNumber === sourceDayNumber && 
                m.mealType === mealType && 
                m.dishId === dishId
            );
            
            if (sourceIndex !== -1) {
                mealsData.splice(sourceIndex, 1);
            }
            
            // Od≈õwie≈º oba dni
            refreshDayMeals(sourceDayNumber);
            refreshDayMeals(targetDayNumber);
            
            // Zamknij modal
            closeCopyDishModal();
            
            // Poka≈º komunikat
            alert(`‚úÖ Przeniesiono danie do dnia ${targetDayNumber}`);
        }

        // Dodaj typ posi≈Çku do dnia (bez da≈Ñ)
        function addMealTypeToDay(dayNumber, mealType) {
            // Sprawd≈∫ czy ju≈º nie istnieje
            const exists = mealsData.some(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            );
            
            if (exists) {
                alert('Ten typ posi≈Çku ju≈º istnieje w tym dniu');
                return;
            }
            
            // Znajd≈∫ datƒô dla tego dnia
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const mealDate = new Date(dateFirst);
            mealDate.setDate(mealDate.getDate() + (dayNumber - 1));
            
            // Pobierz domy≈õlnƒÖ godzinƒô
            const defaultTime = mealTypeDefaults[mealType] || '12:00';
            
            // Dodaj placeholder (pusty typ posi≈Çku bez dania)
            mealsData.push({
                id: null,
                dayNumber,
                date: mealDate.toISOString().split('T')[0],
                mealType,
                dishId: null,  // BRAK DANIA
                portions: 0,
                uwagi: null,
                kolejnosc: 1,
                godzina: defaultTime,
                isPlaceholder: true  // Oznacz jako placeholder
            });
            
            // Dodaj typ do meal_types grupy (je≈õli nie ma)
            if (groupData.meal_types && !groupData.meal_types.includes(mealType)) {
                groupData.meal_types.push(mealType);
            }
            
            refreshDayMeals(dayNumber);
            
            // Zamknij modal
            closeAddMealTypeModal();
        }

        // Przesu≈Ñ danie w g√≥rƒô (zmniejsz kolejno≈õƒá)
        function moveUp(dayNumber, mealType, currentIdx) {
            // Znajd≈∫ wszystkie dania tego posi≈Çku
            const meals = mealsData.filter(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            ).sort((a, b) => (a.kolejnosc || 1) - (b.kolejnosc || 1));
            if (currentIdx > 0 && currentIdx < meals.length) {
                // Zamie≈Ñ kolejno≈õƒá z poprzednim
                const temp = meals[currentIdx].kolejnosc || currentIdx + 1;
                meals[currentIdx].kolejnosc = meals[currentIdx - 1].kolejnosc || currentIdx;
                meals[currentIdx - 1].kolejnosc = temp;
                
                console.log('Swapped:', meals[currentIdx - 1].dishId, '<->', meals[currentIdx].dishId);
                
                refreshDayMeals(dayNumber);
            }
        }
        
        // Przesu≈Ñ danie w d√≥≈Ç (zwiƒôksz kolejno≈õƒá)
        function moveDown(dayNumber, mealType, currentIdx) {
            // Znajd≈∫ wszystkie dania tego posi≈Çku
            const meals = mealsData.filter(m => 
                m.dayNumber === dayNumber && m.mealType === mealType
            ).sort((a, b) => (a.kolejnosc || 1) - (b.kolejnosc || 1));
            if (currentIdx >= 0 && currentIdx < meals.length - 1) {
                // Zamie≈Ñ kolejno≈õƒá z nastƒôpnym
                const temp = meals[currentIdx].kolejnosc || currentIdx + 1;
                meals[currentIdx].kolejnosc = meals[currentIdx + 1].kolejnosc || currentIdx + 2;
                meals[currentIdx + 1].kolejnosc = temp;
                
                console.log('Swapped:', meals[currentIdx].dishId, '<->', meals[currentIdx + 1].dishId);
                
                refreshDayMeals(dayNumber);
            }
        }

        function refreshDayMeals(dayNumber) {
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const currentDate = new Date(dateFirst);
            currentDate.setDate(currentDate.getDate() + (dayNumber - 1));
            
            const container = document.getElementById(`meals-day-${dayNumber}`);
            container.innerHTML = generateMealCardsForDay(dayNumber, currentDate);
        }
        
        // ========== MODAL ZARZƒÑDZANIE ==========
        
        function closeDishModal() {
            document.getElementById('dishModal').style.display = 'none';
            currentEditingMeal = null;
        }
        
        // Wyszukiwanie da≈Ñ
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('dishSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filtered = allDishes.filter(d => 
                        d.nazwa.toLowerCase().includes(query)
                    );
                    renderDishesList(filtered);
                });
            }
        });
        
        // ========== ZAPIS DO BAZY ==========
        
        async function saveAllMeals() {
            if (mealsData.length === 0) {
                alert('‚ö†Ô∏è Brak posi≈Çk√≥w do zapisania');
                return;
            }
            
            if (!confirm(`Zapisaƒá ${mealsData.length} posi≈Çk√≥w?`)) return;
            
            try {
                // Usu≈Ñ wszystkie istniejƒÖce posi≈Çki grupy
                const existingResponse = await fetch(`/api/groups/${groupId}/meals`);
                const existing = await existingResponse.json();
                
                for (const meal of existing) {
                    await fetch(`/api/group-meals/${meal.id}`, { method: 'DELETE' });
                }
                
                // Filtruj placeholdery (nie zapisuj pustych typ√≥w)
                const mealsToSave = mealsData.filter(m => !m.isPlaceholder && m.dishId !== null);
                
                // Dodaj nowe (z kolejno≈õciƒÖ)
                for (const meal of mealsToSave) {
                    const data = {
                        dzien_numer: meal.dayNumber,
                        data: meal.date,
                        typ_posilku: meal.mealType,
                        dish_id: meal.dishId,
                        liczba_porcji: meal.portions,
                        kolejnosc: meal.kolejnosc || 1,
                        godzina: meal.godzina || '12:00',  // DODANE
                        uwagi: meal.uwagi
                    };
                    
                    const response = await fetch(`/api/groups/${groupId}/meals`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'B≈ÇƒÖd zapisu posi≈Çku');
                    }
                }
                
                alert('‚úÖ Jad≈Çospis zapisany pomy≈õlnie!');
                
                // Prze≈Çaduj dane
                await loadExistingMeals();
                generateDaysTimeline(); // Od≈õwie≈º widok
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå B≈ÇƒÖd zapisu: ' + error.message);
            }
        }
        
        // ========== STATYSTYKI ==========
        
        function updateStats() {
            // Ca≈Çkowita liczba posi≈Çk√≥w do zaplanowania
            const dateFirst = new Date(groupData.data_pierwszy_posilek);
            const dateLast = new Date(groupData.data_ostatni_posilek);
            const daysDiff = Math.ceil((dateLast - dateFirst) / (1000 * 60 * 60 * 24)) + 1;
            const mealTypesCount = groupData.meal_types ? groupData.meal_types.length : 0;
            const totalMeals = daysDiff * mealTypesCount;
            
            // Zaplanowane
            const plannedMeals = mealsData.length;
            
            // Procent
            const progress = totalMeals > 0 ? Math.round((plannedMeals / totalMeals) * 100) : 0;
            
            document.getElementById('statPlanned').textContent = `${plannedMeals} / ${totalMeals}`;
            document.getElementById('statProgress').textContent = `${progress}%`;
            
            // Kolor w zale≈ºno≈õci od postƒôpu
            const progressEl = document.getElementById('statProgress');
            if (progress === 100) {
                progressEl.style.color = '#28a745';
            } else if (progress >= 50) {
                progressEl.style.color = '#ffc107';
            } else {
                progressEl.style.color = '#dc3545';
            }
        }
        
        // ========== HELPERS ==========
        
        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            const d = new Date(dateStr);
            return d.toLocaleDateString('pl-PL');
        }
        
    </script>
</body>
</html>