<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - ZarzƒÖdzanie Surowcami</title>
<link rel="stylesheet" href="chefsystent-brand.css">
<link rel="icon" type="image/png" href="piktogram.png">
    <style>
    /* Dodatkowe style specyficzne dla tabeli surowc√≥w */
    .table-container {
        overflow-x: auto;
        margin-bottom: 30px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    thead {
        background: #f8f9fa;
    }
    th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #0A1F44;
        border-bottom: 2px solid #e0e0e0;
        cursor: pointer;
        user-select: none;
    }
    th:hover {
        background: #e9ecef;
    }
    th.sorted-asc::after { content: ' ‚Üë'; color: #D4AF37; }
    th.sorted-desc::after { content: ' ‚Üì'; color: #D4AF37; }
    td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    tbody tr:hover {
        background: #f8f9fa;
    }
    .badge-vegetarian { background: #4CAF50; color: white; }
    .badge-vegan { background: #8BC34A; color: white; }
    .allergen-tag {
        display: inline-block;
        background: #ff9800;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin: 2px;
    }
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background: linear-gradient(135deg, #0A1F44 0%, #1a3a6b 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    .stat-card h3 { font-size: 2em; margin-bottom: 5px; color: #D4AF37; }
    .stat-card p { opacity: 0.9; }
    
    /* Import CSV modal styles */
    #importPreviewTable {
        width: 100%;
        max-height: 400px;
        overflow-y: auto;
        margin: 20px 0;
    }
    #importPreviewTable table {
        font-size: 13px;
    }
    #importPreviewTable td {
        padding: 8px;
    }
    .duplicate-row {
        background: #fff3cd !important;
        border-left: 3px solid #ffc107;
    }
    .error-row {
        background: #f8d7da !important;
        border-left: 3px solid #dc3545;
    }
    .import-options {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    .import-options label {
        display: block;
        margin: 10px 0;
        font-weight: 500;
    }
    .progress-bar {
        width: 100%;
        height: 25px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin: 15px 0;
        display: none;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #D4AF37 0%, #f0c54a 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
    }
    .file-upload-area {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin: 20px 0;
    }
    .file-upload-area:hover {
        border-color: #D4AF37;
        background: #f8f9fa;
    }
    .file-upload-area.dragover {
        border-color: #D4AF37;
        background: #fff8e1;
    }
</style>
</head>
<body>
    <div class="container">
        <header>
    <div class="header-logo">
        <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
    </div>
    <p>System ZarzƒÖdzania KuchniƒÖ - Surowce</p>
    
    <nav>
        <a href="index.html" class="active">Surowce</a>
        <a href="recipes.html">Receptury</a>
        <a href="dishes.html">Dania</a>
<a href="groups.html">Grupy</a>
    </nav>
</header>
        
        <div class="content">
            <!-- Message area -->
            <div id="messageArea"></div>
            
            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalCount">0</h3>
                    <p>Wszystkich surowc√≥w</p>
                </div>
                <div class="stat-card">
                    <h3 id="veganCount">0</h3>
                    <p>Wega≈Ñskich</p>
                </div>
                <div class="stat-card">
                    <h3 id="vegetarianCount">0</h3>
                    <p>Wegetaria≈Ñskich</p>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj surowiec...">
                </div>
                <select id="typeFilter">
                    <option value="">Wszystkie typy</option>
                </select>
                <select id="dietFilter">
                    <option value="">Wszystkie diety</option>
                    <option value="vegan">Wega≈Ñskie</option>
                    <option value="vegetarian">Wegetaria≈Ñskie</option>
                </select>
<button class="btn btn-secondary" onclick="openImportModal()">üì§ Import CSV</button>
<button class="btn btn-primary" onclick="exportIngredients()">üì• Eksport CSV</button>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj surowiec</button>
            </div>
            
            <!-- Table -->
            <div class="table-container">
                <table id="ingredientsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('id')">ID</th>
                            <th onclick="sortTable('nazwa')">Nazwa</th>
                            <th onclick="sortTable('jm_podstawowa')">JM</th>
                            <th onclick="sortTable('typ')">Typ</th>
                            <th onclick="sortTable('grupa')">Grupa</th>
                            <th onclick="sortTable('dzial')">Dzia≈Ç</th>
                            <th>Dieta</th>
                            <th>Alergeny</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="9" class="loading">≈Åadowanie danych...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal Dodaj/Edytuj -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj nowy surowiec</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="ingredientForm" onsubmit="saveIngredient(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label>Nazwa *</label>
                        <input type="text" id="nazwa" required>
                    </div>
                    <div class="form-group">
                        <label>Jednostka miary *</label>
                        <select id="jm_podstawowa" required>
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="l">l</option>
                            <option value="ml">ml</option>
                            <option value="szt">szt</option>
                            <option value="op">op</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Typ</label>
                        <select id="typ">
                            <option value="">Wybierz typ</option>
                            <option value="warzywo">Warzywo</option>
                            <option value="owoc">Owoc</option>
                            <option value="miƒôso">Miƒôso</option>
                            <option value="wƒôdlina">Wƒôdlina</option>
                            <option value="nabia≈Ç">Nabia≈Ç</option>
                            <option value="przyprawa">Przyprawa</option>
                            <option value="zio≈Ço_≈õwie≈ºe">Zio≈Ço ≈õwie≈ºe</option>
                            <option value="inne">Inne</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Grupa</label>
                        <input type="text" id="grupa">
                    </div>
                    <div class="form-group">
                        <label>Dzia≈Ç</label>
                        <select id="dzial">
                            <option value="kuchnia">Kuchnia</option>
                            <option value="bar">Bar</option>
                            <option value="og√≥lne">Og√≥lne</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Dieta</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="wegetarianski"> Wegetaria≈Ñski</label>
                            <label><input type="checkbox" id="weganski"> Wega≈Ñski</label>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Alergeny (14 UE)</label>
                        <div id="allergensCheckboxes" class="checkbox-group"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Import CSV -->
    <div id="importModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Import surowc√≥w z CSV</h2>
                <span class="close" onclick="closeImportModal()">&times;</span>
            </div>
            
            <div style="padding: 20px;">
                <!-- Upload area -->
                <div id="fileUploadArea" class="file-upload-area" onclick="document.getElementById('csvFileInput').click()">
                    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    <p style="font-size: 1.2em; margin: 0 0 10px 0;">üìÅ Kliknij lub przeciƒÖgnij plik CSV</p>
                    <p style="color: #666; font-size: 0.9em; margin: 0;">Format: id,nazwa,typ,grupa,dzial,jm_podstawowa,wegetarianski,weganski,alergeny</p>
                </div>

                <!-- Preview area -->
                <div id="importPreviewContainer" style="display: none;">
                    <div class="import-options">
                        <h3>Opcje importu</h3>
                        <label>
                            <input type="radio" name="duplicateAction" value="skip" checked>
                            ‚ùå Pomi≈Ñ duplikaty (nie importuj je≈õli nazwa ju≈º istnieje)
                        </label>
                        <label>
                            <input type="radio" name="duplicateAction" value="overwrite">
                            üîÑ Nadpisz istniejƒÖce (zaktualizuj je≈õli nazwa ju≈º istnieje)
                        </label>
                        <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            <strong>Znaleziono:</strong> 
                            <span id="totalRows">0</span> wierszy | 
                            <span id="newRows" style="color: #28a745;">0 nowych</span> | 
                            <span id="duplicateRows" style="color: #ffc107;">0 duplikat√≥w</span> |
                            <span id="errorRows" style="color: #dc3545;">0 b≈Çƒôd√≥w</span>
                        </p>
                    </div>

                    <div id="importPreviewTable"></div>

                    <!-- Progress bar -->
                    <div class="progress-bar" id="importProgress">
                        <div class="progress-bar-fill" id="importProgressFill">0%</div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeImportModal()">Anuluj</button>
                        <button type="button" class="btn btn-primary" onclick="executeImport()" id="importButton">
                            ‚úÖ Importuj
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';
    
    let allIngredients = [];
    let filteredIngredients = [];
    let allergensList = [];
    let currentSort = { column: 'id', direction: 'asc' };
    let importData = null;
    let duplicatesInfo = null;

    // Za≈Çaduj listƒô alergen√≥w
    async function loadAllergens() {
        try {
            const res = await fetch(`${API_URL}/api/allergens`);
            allergensList = await res.json();
            renderAllergensCheckboxes();
        } catch (err) {
            console.error('B≈ÇƒÖd ≈Çadowania alergen√≥w:', err);
        }
    }

    function renderAllergensCheckboxes() {
        const container = document.getElementById('allergensCheckboxes');
        container.innerHTML = allergensList.map(a => `
            <label style="display: block; margin: 5px 0;">
                <input type="checkbox" class="allergen-checkbox" value="${a.id}">
                ${a.kod} - ${a.nazwa}
            </label>
        `).join('');
    }

    // Za≈Çaduj surowce
    async function loadIngredients() {
        try {
            const res = await fetch(`${API_URL}/api/ingredients`);
            allIngredients = await res.json();
            
            // Statystyki
            document.getElementById('totalCount').textContent = allIngredients.length;
            document.getElementById('veganCount').textContent = allIngredients.filter(i => i.weganski).length;
            document.getElementById('vegetarianCount').textContent = allIngredients.filter(i => i.wegetarianski).length;
            
            // Wype≈Çnij filtry
            const types = [...new Set(allIngredients.map(i => i.typ).filter(Boolean))];
            document.getElementById('typeFilter').innerHTML = '<option value="">Wszystkie typy</option>' +
                types.map(t => `<option value="${t}">${t}</option>`).join('');
            
            applyFilters();
        } catch (err) {
            console.error('B≈ÇƒÖd ≈Çadowania:', err);
            alert('B≈ÇƒÖd ≈Çadowania danych');
        }
    }

    // Filtrowanie
    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const dietFilter = document.getElementById('dietFilter').value;
        
        filteredIngredients = allIngredients.filter(ing => {
            const matchSearch = !search || ing.nazwa.toLowerCase().includes(search);
            const matchType = !typeFilter || ing.typ === typeFilter;
            const matchDiet = !dietFilter || 
                (dietFilter === 'vegan' && ing.weganski) ||
                (dietFilter === 'vegetarian' && ing.wegetarianski);
            return matchSearch && matchType && matchDiet;
        });
        
        renderTable();
    }

    // Sortowanie
    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }
        
        filteredIngredients.sort((a, b) => {
            let valA = a[column] || '';
            let valB = b[column] || '';
            
            if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            
            if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
            if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });
        
        renderTable();
        
        // Oznacz kolumnƒô
        document.querySelectorAll('th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
        });
        event.target.classList.add(`sorted-${currentSort.direction}`);
    }

    // Renderowanie tabeli
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        
        if (filteredIngredients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">Brak wynik√≥w</td></tr>';
            return;
        }
        
        tbody.innerHTML = filteredIngredients.map(ing => {
            const allergens = Array.isArray(ing.alergeny) ? 
                ing.alergeny.map(id => {
                    const allergen = allergensList.find(a => a.id === id);
                    return allergen ? `<span class="allergen-tag">${allergen.kod}</span>` : '';
                }).join('') : '';
            
            const diet = [];
            if (ing.wegetarianski) diet.push('<span class="badge-vegetarian">ü•¨ Wege</span>');
            if (ing.weganski) diet.push('<span class="badge-vegan">üå± Vegan</span>');
            
            return `
                <tr>
                    <td>${ing.id}</td>
                    <td><strong>${ing.nazwa}</strong></td>
                    <td>${ing.jm_podstawowa || '-'}</td>
                    <td>${ing.typ || '-'}</td>
                    <td>${ing.grupa || '-'}</td>
                    <td>${ing.dzial || '-'}</td>
                    <td>${diet.join(' ')}</td>
                    <td>${allergens || '-'}</td>
                    <td>
                        <button class="btn-icon" onclick="editIngredient(${ing.id})" title="Edytuj">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteIngredient(${ing.id})" title="Usu≈Ñ">üóëÔ∏è</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // CRUD Operations
    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Dodaj nowy surowiec';
        document.getElementById('ingredientForm').reset();
        document.getElementById('editId').value = '';
        document.querySelectorAll('.allergen-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('modal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    async function editIngredient(id) {
        const ing = allIngredients.find(i => i.id === id);
        if (!ing) return;
        
        document.getElementById('modalTitle').textContent = 'Edytuj surowiec';
        document.getElementById('editId').value = id;
        document.getElementById('nazwa').value = ing.nazwa;
        document.getElementById('jm_podstawowa').value = ing.jm_podstawowa || 'kg';
        document.getElementById('typ').value = ing.typ || '';
        document.getElementById('grupa').value = ing.grupa || '';
        document.getElementById('dzial').value = ing.dzial || 'kuchnia';
        document.getElementById('wegetarianski').checked = ing.wegetarianski || false;
        document.getElementById('weganski').checked = ing.weganski || false;
        
        // Alergeny
        document.querySelectorAll('.allergen-checkbox').forEach(cb => {
            cb.checked = Array.isArray(ing.alergeny) && ing.alergeny.includes(parseInt(cb.value));
        });
        
        document.getElementById('modal').style.display = 'block';
    }

    async function saveIngredient(e) {
        e.preventDefault();
        
        const selectedAllergens = Array.from(document.querySelectorAll('.allergen-checkbox:checked'))
            .map(cb => parseInt(cb.value));
        
        const data = {
            nazwa: document.getElementById('nazwa').value,
            jm_podstawowa: document.getElementById('jm_podstawowa').value,
            typ: document.getElementById('typ').value || null,
            grupa: document.getElementById('grupa').value || null,
            dzial: document.getElementById('dzial').value || null,
            wegetarianski: document.getElementById('wegetarianski').checked,
            weganski: document.getElementById('weganski').checked,
            alergeny: selectedAllergens
        };
        
        const editId = document.getElementById('editId').value;
        const url = editId ? `${API_URL}/api/ingredients/${editId}` : `${API_URL}/api/ingredients`;
        const method = editId ? 'PUT' : 'POST';
        
        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                alert(editId ? 'Surowiec zaktualizowany!' : 'Surowiec dodany!');
                closeModal();
                loadIngredients();
            } else {
                const error = await res.json();
                alert('B≈ÇƒÖd: ' + (error.error || 'Nieznany b≈ÇƒÖd'));
            }
        } catch (err) {
            alert('B≈ÇƒÖd zapisu: ' + err.message);
        }
    }

    async function deleteIngredient(id) {
        if (!confirm('Czy na pewno usunƒÖƒá ten surowiec?')) return;
        
        try {
            const res = await fetch(`${API_URL}/api/ingredients/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert('Surowiec usuniƒôty!');
                loadIngredients();
            } else {
                alert('B≈ÇƒÖd usuwania');
            }
        } catch (err) {
            alert('B≈ÇƒÖd: ' + err.message);
        }
    }

    // Eksport do CSV
    async function exportIngredients() {
        try {
            const response = await fetch(`${API_URL}/api/ingredients/export/csv`);
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `surowce_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (err) {
            alert('B≈ÇƒÖd eksportu: ' + err.message);
        }
    }

    // ============ IMPORT CSV ============

    function openImportModal() {
        document.getElementById('importModal').style.display = 'block';
        document.getElementById('importPreviewContainer').style.display = 'none';
        document.getElementById('fileUploadArea').style.display = 'block';
        document.getElementById('csvFileInput').value = '';
        importData = null;
        duplicatesInfo = null;
    }

    function closeImportModal() {
        document.getElementById('importModal').style.display = 'none';
    }

    // Drag & drop
    const uploadArea = document.getElementById('fileUploadArea');
    if (uploadArea) {
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files } });
            }
        });
    }

    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const text = e.target.result;
                await parseAndPreviewCSV(text);
            } catch (err) {
                alert('B≈ÇƒÖd odczytu pliku: ' + err.message);
            }
        };
        reader.readAsText(file);
    }

    async function parseAndPreviewCSV(csvText) {
        // Usu≈Ñ BOM je≈õli istnieje
        csvText = csvText.replace(/^\uFEFF/, '');
        
        const lines = csvText.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            alert('Plik CSV jest pusty lub nieprawid≈Çowy');
            return;
        }
        
        // Parsuj nag≈Ç√≥wek
        const headers = parseCSVLine(lines[0]);
        
        // Parsuj wiersze danych
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            if (values.length !== headers.length) continue;
            
            const row = {};
            headers.forEach((header, idx) => {
                row[header] = values[idx];
            });
            rows.push(row);
        }
        
        if (rows.length === 0) {
            alert('Brak danych do importu');
            return;
        }
        
        // Sprawd≈∫ duplikaty w bazie
        importData = rows;
        await checkDuplicates();
        renderImportPreview();
    }

    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                if (inQuotes && line[i + 1] === '"') {
                    current += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current.trim());
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current.trim());
        
        return result;
    }

    async function checkDuplicates() {
        try {
            const res = await fetch(`${API_URL}/api/ingredients/check-duplicates`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ names: importData.map(row => row.nazwa) })
            });
            duplicatesInfo = await res.json();
        } catch (err) {
            console.error('B≈ÇƒÖd sprawdzania duplikat√≥w:', err);
            duplicatesInfo = { duplicates: [], existingIds: {} };
        }
    }

    function renderImportPreview() {
        const container = document.getElementById('importPreviewTable');
        
        let newCount = 0;
        let duplicateCount = 0;
        let errorCount = 0;
        
        const tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th>Nazwa</th>
                        <th>JM</th>
                        <th>Typ</th>
                        <th>Grupa</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${importData.map((row, idx) => {
                        const isDuplicate = duplicatesInfo.duplicates.includes(row.nazwa);
                        const hasError = !row.nazwa || !row.jm_podstawowa;
                        
                        if (hasError) errorCount++;
                        else if (isDuplicate) duplicateCount++;
                        else newCount++;
                        
                        const rowClass = hasError ? 'error-row' : (isDuplicate ? 'duplicate-row' : '');
                        const status = hasError ? '‚ùå B≈ÇƒÖd' : (isDuplicate ? '‚ö†Ô∏è Duplikat' : '‚úÖ Nowy');
                        
                        return `
                            <tr class="${rowClass}">
                                <td>${idx + 1}</td>
                                <td>${row.nazwa || '<brak>'}</td>
                                <td>${row.jm_podstawowa || '<brak>'}</td>
                                <td>${row.typ || '-'}</td>
                                <td>${row.grupa || '-'}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
        
        container.innerHTML = tableHTML;
        
        document.getElementById('totalRows').textContent = importData.length;
        document.getElementById('newRows').textContent = newCount;
        document.getElementById('duplicateRows').textContent = duplicateCount;
        document.getElementById('errorRows').textContent = errorCount;
        
        document.getElementById('fileUploadArea').style.display = 'none';
        document.getElementById('importPreviewContainer').style.display = 'block';
    }

    async function executeImport() {
        const duplicateAction = document.querySelector('input[name="duplicateAction"]:checked').value;
        
        if (!importData || importData.length === 0) {
            alert('Brak danych do importu');
            return;
        }
        
        const button = document.getElementById('importButton');
        button.disabled = true;
        button.textContent = '‚è≥ Importowanie...';
        
        const progressBar = document.getElementById('importProgress');
        const progressFill = document.getElementById('importProgressFill');
        progressBar.style.display = 'block';
        
        try {
            let imported = 0;
            let skipped = 0;
            let errors = 0;
            
            for (let i = 0; i < importData.length; i++) {
                const row = importData[i];
                const progress = Math.round(((i + 1) / importData.length) * 100);
                progressFill.style.width = progress + '%';
                progressFill.textContent = progress + '%';
                
                // Walidacja podstawowa
                if (!row.nazwa || !row.jm_podstawowa) {
                    errors++;
                    continue;
                }
                
                const isDuplicate = duplicatesInfo.duplicates.includes(row.nazwa);
                
                if (isDuplicate && duplicateAction === 'skip') {
                    skipped++;
                    continue;
                }
                
                // Przygotuj dane
                const data = {
                    nazwa: row.nazwa,
                    jm_podstawowa: row.jm_podstawowa,
                    typ: row.typ || null,
                    grupa: row.grupa || null,
                    dzial: row.dzial || null,
                    wegetarianski: row.wegetarianski === 'true' || row.wegetarianski === '1',
                    weganski: row.weganski === 'true' || row.weganski === '1',
                    alergeny: row.alergeny ? JSON.parse(row.alergeny) : []
                };
                
                // Import/update
                try {
                    if (isDuplicate && duplicateAction === 'overwrite') {
                        const existingId = duplicatesInfo.existingIds[row.nazwa];
                        await fetch(`${API_URL}/api/ingredients/${existingId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    } else {
                        await fetch(`${API_URL}/api/ingredients`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                    }
                    imported++;
                } catch (err) {
                    errors++;
                    console.error('B≈ÇƒÖd importu wiersza:', row, err);
                }
                
                // Ma≈Ça pauza ≈ºeby nie przeciƒÖ≈ºyƒá serwera
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            
            alert(`Import zako≈Ñczony!\n‚úÖ Zaimportowano: ${imported}\n‚ö†Ô∏è Pominiƒôto: ${skipped}\n‚ùå B≈Çƒôd√≥w: ${errors}`);
            closeImportModal();
            loadIngredients();
            
        } catch (err) {
            alert('B≈ÇƒÖd importu: ' + err.message);
        } finally {
            button.disabled = false;
            button.textContent = '‚úÖ Importuj';
            progressBar.style.display = 'none';
        }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('typeFilter').addEventListener('change', applyFilters);
    document.getElementById('dietFilter').addEventListener('change', applyFilters);

    // Close modals on outside click
    window.onclick = (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    };

    // Init
    loadAllergens();
    loadIngredients();
    </script>
</body>
</html>
