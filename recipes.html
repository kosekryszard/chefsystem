<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefSystent - Receptury</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Receptury</p>
            
            <nav>
                <a href="index.html">üè† Start</a>
                <a href="ingredients.html">Surowce</a>
                <a href="recipes.html" class="active">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty</a>
                <a href="shopping.html">Zakupy</a>
            </nav>
        </header>

        <div class="content">
            <!-- Filtry status√≥w -->
            <div class="filters-bar">
                <button class="filter-btn active" data-filter="all" onclick="filterRecipes('all')">
                    Wszystkie
                </button>
                <button class="filter-btn" data-filter="draft" onclick="filterRecipes('draft')">
                    üìù Robocze
                </button>
                <button class="filter-btn" data-filter="active" onclick="filterRecipes('active')">
                    ‚úÖ Aktywne
                </button>
                <button class="filter-btn" data-filter="archived" onclick="filterRecipes('archived')">
                    üì¶ Archiwum
                </button>
            </div>

            <!-- Controls -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>Lista receptur</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportRecipes()">üì• Eksport CSV</button>
                    <button class="btn btn-primary" onclick="openAddModal()">‚ûï Dodaj recepturƒô</button>
                </div>
            </div>

            <!-- Search -->
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Wyszukaj recepturƒô..." onkeyup="applyFilters()">
                </div>
            </div>
            
            <!-- Grid receptur -->
            <div class="items-grid" id="recipesGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    ≈Åadowanie receptur...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal dodawania/edycji (zachowany z obecnej wersji) -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Dodaj recepturƒô</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="recipeForm" onsubmit="saveRecipe(event)">
                    <input type="hidden" id="editId">
                    
                    <div class="form-group">
                        <label>Nazwa *</label>
                        <input type="text" id="nazwa" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Typ</label>
                            <input type="text" id="typ" placeholder="Zupa, Sos, Dodatek">
                        </div>
                        <div class="form-group">
                            <label>Wydajno≈õƒá (liczba)</label>
                            <input type="number" step="0.01" id="wydajnosc_ilosc">
                        </div>
                        <div class="form-group">
                            <label>Jednostka wydajno≈õci</label>
                            <input type="text" id="wydajnosc_jm" placeholder="porcja, kg, l">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Opis</label>
                        <textarea id="opis"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="wegetarianski">
                                Wegetaria≈Ñska
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="weganski">
                                Wega≈Ñska
                            </label>
                        </div>
                    </div>

                    <!-- Instrukcje -->
                    <div class="form-group">
                        <label>Instrukcje (JSON format)</label>
                        <textarea id="instrukcja" rows="5" placeholder='[{"krok": 1, "tekst": "Pokr√≥j warzywa"}]'></textarea>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" class="btn" onclick="closeModal()">Anuluj</button>
                        <button type="submit" class="btn btn-success">Zapisz</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chefsystem.vercel.app';
        
        let allRecipes = [];
        let filteredRecipes = [];
        let currentFilter = 'all';

        // ≈Åadowanie danych
        window.addEventListener('DOMContentLoaded', () => {
            loadRecipes();
        });

        async function loadRecipes() {
            try {
                const response = await fetch(`${API_URL}/api/recipes`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania');
                
                allRecipes = await response.json();
                filteredRecipes = [...allRecipes];
                
                renderGrid();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('recipesGrid').innerHTML = 
                    '<div class="loading">‚ùå B≈ÇƒÖd ≈Çadowania danych</div>';
            }
        }

        // Filtry
        function filterRecipes(filter) {
            currentFilter = filter;
            
            // Aktywuj przycisk
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredRecipes = allRecipes.filter(recipe => {
                // Search
                const matchesSearch = recipe.nazwa.toLowerCase().includes(searchTerm);
                
                // Status filter
                let matchesStatus = true;
                if (currentFilter !== 'all') {
                    matchesStatus = recipe.status === currentFilter;
                }
                
                return matchesSearch && matchesStatus;
            });
            
            renderGrid();
        }

        // Renderowanie grid
        function renderGrid() {
            const grid = document.getElementById('recipesGrid');
            
            if (filteredRecipes.length === 0) {
                grid.innerHTML = '<div class="loading">Brak wynik√≥w</div>';
                return;
            }
            
            grid.innerHTML = filteredRecipes.map(recipe => {
                // Status badge
                const statusBadges = {
                    'draft': '<span class="badge badge-status-draft">üìù Robocze</span>',
                    'active': '<span class="badge badge-status-active">‚úÖ Aktywne</span>',
                    'archived': '<span class="badge badge-status-archived">üì¶ Archiwum</span>'
                };
                const statusBadge = statusBadges[recipe.status] || '';
                
                // In use badge
                const inUseBadge = recipe.in_use ? '<span class="item-card-badge">üîí W u≈ºyciu</span>' : '';
                
                // Diet badges
                const dietBadges = [];
                if (recipe.weganski) dietBadges.push('<span class="badge badge-vegan">üå± Vegan</span>');
                if (recipe.wegetarianski) dietBadges.push('<span class="badge badge-vegetarian">ü•¨ Wege</span>');
                
                return `
                    <div class="item-card" data-id="${recipe.id}">
                        <!-- Header (klikalne) -->
                        <div class="item-card-header" onclick="viewRecipe(${recipe.id})">
                            <h3 class="item-card-title">${recipe.nazwa}</h3>
                            ${inUseBadge}
                        </div>
                        
                        <!-- Body -->
                        <div class="item-card-body">
                            <!-- Opis -->
                            ${recipe.opis ? `<p class="item-card-description">${recipe.opis}</p>` : ''}
                            
                            <!-- Metadane -->
                            <div class="item-card-meta">
                                ${recipe.typ ? `<span class="badge badge-type">${recipe.typ}</span>` : ''}
                                ${recipe.wydajnosc_ilosc ? `<span class="badge badge-yield">${recipe.wydajnosc_ilosc} ${recipe.wydajnosc_jm || 'porcji'}</span>` : ''}
                                ${statusBadge}
                                ${dietBadges.join('')}
                            </div>
                            
                            <!-- Przyciski akcji -->
                            <div class="action-buttons">
                                <button class="action-btn btn-edit" onclick="event.stopPropagation(); editRecipe(${recipe.id})">
                                    ‚úèÔ∏è Edytuj
                                </button>
                                <button class="action-btn btn-duplicate" onclick="event.stopPropagation(); duplicateRecipe(${recipe.id})">
                                    üìã Duplikuj
                                </button>
                                <button class="action-btn btn-status" onclick="showStatusMenu(event, ${recipe.id})">
                                    üìä Status
                                </button>
                                <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteRecipe(${recipe.id})" ${recipe.in_use ? 'disabled title="Nie mo≈ºna usunƒÖƒá - receptura jest w u≈ºyciu"' : ''}>
                                    üóëÔ∏è Usu≈Ñ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // === FLOATING STATUS MENU === 
        function showStatusMenu(event, recipeId) {
            event.stopPropagation();
            
            // Usu≈Ñ poprzednie menu
            const existing = document.getElementById('floatingStatusMenu');
            if (existing) existing.remove();
            
            // Utw√≥rz menu
            const menu = document.createElement('div');
            menu.id = 'floatingStatusMenu';
            menu.className = 'floating-status-menu';
            menu.innerHTML = `
                <div onclick="changeStatus(${recipeId}, 'draft')">üìù Robocze</div>
                <div onclick="changeStatus(${recipeId}, 'active')">‚úÖ Aktywne</div>
                <div onclick="changeStatus(${recipeId}, 'archived')">üì¶ Archiwum</div>
            `;
            
            document.body.appendChild(menu);
            
            // Pobierz wymiary
            const buttonRect = event.target.getBoundingClientRect();
            const menuRect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            const viewportWidth = window.innerWidth;
            
            // Inteligentne pozycjonowanie
            let top, left;
            
            // Sprawd≈∫ czy jest miejsce poni≈ºej
            if (buttonRect.bottom + menuRect.height + 10 < viewportHeight) {
                top = buttonRect.bottom + 5;
            } else {
                top = buttonRect.top - menuRect.height - 5;
            }
            
            // Sprawd≈∫ czy nie wychodzi za prawƒÖ krawƒôd≈∫
            if (buttonRect.left + menuRect.width > viewportWidth) {
                left = buttonRect.right - menuRect.width;
            } else {
                left = buttonRect.left;
            }
            
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            
            // Zamknij przy klikniƒôciu poza menu
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 10);
        }

        // Zmie≈Ñ status
        async function changeStatus(recipeId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/api/recipes/${recipeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zmiany statusu');
                
                document.getElementById('floatingStatusMenu')?.remove();
                loadRecipes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zmiany statusu');
            }
        }

        // PodglƒÖd receptury (nowa strona)
        function viewRecipe(recipeId) {
            window.location.href = `recipes-view.html?id=${recipeId}`;
        }

        // === CRUD OPERATIONS ===
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Dodaj recepturƒô';
            document.getElementById('recipeForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('recipeModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('recipeModal').style.display = 'none';
        }

        async function editRecipe(id) {
            const recipe = allRecipes.find(r => r.id === id);
            if (!recipe) return;
            
            document.getElementById('modalTitle').textContent = 'Edytuj recepturƒô';
            document.getElementById('editId').value = recipe.id;
            document.getElementById('nazwa').value = recipe.nazwa || '';
            document.getElementById('typ').value = recipe.typ || '';
            document.getElementById('opis').value = recipe.opis || '';
            document.getElementById('wydajnosc_ilosc').value = recipe.wydajnosc_ilosc || '';
            document.getElementById('wydajnosc_jm').value = recipe.wydajnosc_jm || '';
            document.getElementById('wegetarianski').checked = recipe.wegetarianski || false;
            document.getElementById('weganski').checked = recipe.weganski || false;
            document.getElementById('instrukcja').value = recipe.instrukcja ? JSON.stringify(recipe.instrukcja, null, 2) : '';
            
            document.getElementById('recipeModal').style.display = 'block';
        }

        async function saveRecipe(event) {
            event.preventDefault();
            
            const id = document.getElementById('editId').value;
            const data = {
                nazwa: document.getElementById('nazwa').value,
                typ: document.getElementById('typ').value,
                opis: document.getElementById('opis').value,
                wydajnosc_ilosc: parseFloat(document.getElementById('wydajnosc_ilosc').value) || null,
                wydajnosc_jm: document.getElementById('wydajnosc_jm').value,
                wegetarianski: document.getElementById('wegetarianski').checked,
                weganski: document.getElementById('weganski').checked
            };
            
            // Parse instrukcja
            const instrText = document.getElementById('instrukcja').value.trim();
            if (instrText) {
                try {
                    data.instrukcja = JSON.parse(instrText);
                } catch (e) {
                    alert('B≈ÇƒÖd w formacie JSON instrukcji');
                    return;
                }
            }
            
            try {
                const url = id ? `${API_URL}/api/recipes/${id}` : `${API_URL}/api/recipes`;
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd zapisu');
                
                alert(id ? 'Zapisano zmiany' : 'Dodano recepturƒô');
                closeModal();
                loadRecipes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd zapisu: ' + error.message);
            }
        }

        async function duplicateRecipe(id) {
            const recipe = allRecipes.find(r => r.id === id);
            if (!recipe) return;
            
            if (!confirm(`Duplikowaƒá recepturƒô "${recipe.nazwa}"?`)) return;
            
            const newRecipe = {
                nazwa: recipe.nazwa + ' (kopia)',
                typ: recipe.typ,
                opis: recipe.opis,
                wydajnosc_ilosc: recipe.wydajnosc_ilosc,
                wydajnosc_jm: recipe.wydajnosc_jm,
                wegetarianski: recipe.wegetarianski,
                weganski: recipe.weganski,
                instrukcja: recipe.instrukcja,
                status: 'draft' // Zawsze jako robocze
            };
            
            try {
                const response = await fetch(`${API_URL}/api/recipes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newRecipe)
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd duplikowania');
                
                alert('Zduplikowano recepturƒô');
                loadRecipes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd duplikowania: ' + error.message);
            }
        }

        async function deleteRecipe(id) {
            const recipe = allRecipes.find(r => r.id === id);
            if (!recipe) return;
            
            if (recipe.in_use) {
                alert('Nie mo≈ºna usunƒÖƒá receptury kt√≥ra jest w u≈ºyciu');
                return;
            }
            
            if (!confirm(`Czy na pewno usunƒÖƒá "${recipe.nazwa}"?`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/recipes/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd usuwania');
                
                alert('Usuniƒôto recepturƒô');
                loadRecipes();
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd usuwania: ' + error.message);
            }
        }

        /// ========== EKSPORT ==========
function exportRecipes() {
  window.location.href = '/api/recipes/export/csv';
}

// ========== IMPORT ==========
async function importRecipes(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!confirm(`Importowaƒá receptury z pliku: ${file.name}?`)) {
    event.target.value = '';
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const response = await fetch('/api/recipes/import/csv', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok) {
      let message = `‚úÖ Import zako≈Ñczony!\n\n`;
      message += `Zaimportowano: ${result.success}\n`;
      message += `Pominiƒôto (duplikaty): ${result.skipped}\n`;
      message += `B≈Çƒôdy: ${result.errors.length}`;
      
      if (result.errors.length > 0) {
        message += `\n\nPierwsze b≈Çƒôdy:\n`;
        result.errors.slice(0, 3).forEach(err => {
          message += `- Wiersz ${err.row}: ${err.error}\n`;
        });
      }
      
      alert(message);
      loadData();
    } else {
      alert('‚ùå B≈ÇƒÖd importu: ' + result.error);
    }
  } catch (error) {
    alert('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ' + error.message);
  } finally {
    event.target.value = '';
  }
}

        // Zamykanie modala klikniƒôciem poza
        window.onclick = function(event) {
            const modal = document.getElementById('recipeModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
