<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chefsystent - Zakupy</title>
    <link rel="stylesheet" href="chefsystent-brand.css">
    <link rel="icon" type="image/png" href="piktogram.png">
    
    <!-- pdfmake dla eksportu PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #0A1F44 0%, #1a3a6b 100%);
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .content { padding: 30px; }
        
        /* Filtry g√≥rne */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
        }
        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
        }
        
        /* Sekcje ≈∫r√≥de≈Ç */
        .sources-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .source-section {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .source-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #0A1F44 100%);
            padding: 15px 20px;
            color: white;
            font-size: 18px;
            font-weight: 700;
        }
        
        .source-body {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .source-item {
            border: 2px solid #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .source-item:hover {
            border-color: #D4AF37;
        }
        .source-item.selected {
            background: #fff8e1;
            border-color: #D4AF37;
        }
        
        .source-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .source-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .source-checkbox label {
            font-weight: 600;
            color: #0A1F44;
            cursor: pointer;
        }
        
        .source-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        /* Dni */
        .days-list {
            margin-left: 30px;
            display: none;
        }
        .days-list.visible {
            display: block;
        }
        .day-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            font-size: 14px;
        }
        .day-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* Rƒôczne ilo≈õci dla kart menu */
        .manual-amounts {
            margin-left: 30px;
            display: none;
        }
        .manual-amounts.visible {
            display: block;
        }
        .amount-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .amount-item label {
            font-size: 13px;
            color: #333;
        }
        .amount-item input {
            width: 80px;
            padding: 5px 8px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
        }
        
        /* Akcje */
        .actions-bar {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* Dropdown PDF */
        .pdf-dropdown {
            position: relative;
            display: inline-block;
        }
        .pdf-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 101;
            min-width: 220px;
            margin-bottom: 5px;
        }
        .pdf-menu.active { display: block; }
        .pdf-menu button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .pdf-menu button:hover {
            background: #f8f9fa;
        }
        
        /* Buttony */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: #D4AF37;
            color: white;
        }
        .btn-primary:hover { background: #b8941f; }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover { background: #218838; }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-logo">
                <img src="LOGO_chefsystent.png" alt="Chefsystent Logo">
            </div>
            <p>System ZarzƒÖdzania KuchniƒÖ - Zakupy</p>
            
            <nav>
                <a href="index.html">Surowce</a>
                <a href="recipes.html">Receptury</a>
                <a href="dishes.html">Dania</a>
                <a href="groups.html">Grupy</a>
                <a href="events.html">Eventy</a>
                <a href="menu-cards.html">Karty Menu</a>
                <a href="shopping.html" class="active">Zakupy ‚Üí</a>
            </nav>
        </header>

        <div class="content">
            <h2>Modu≈Ç Zakup√≥w</h2>
            
            <!-- Filtry -->
            <div class="filters-bar">
                <div class="filter-group">
                    <label>Data do:</label>
                    <input type="date" id="filterDateTo">
                </div>
                <div class="filter-group">
                    <label>Lokal:</label>
                    <select id="filterLokal">
                        <option value="wszystkie">Wszystkie</option>
                        <option value="Szczelinka">Szczelinka</option>
                        <option value="Pasterka">Pasterka</option>
                        <option value="Stolove">Stolove</option>
                        <option value="Szczeliniec">Szczeliniec</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="loadSources()">
                        üîç Szukaj
                    </button>
                </div>
            </div>
            
            <!-- Sekcje ≈∫r√≥de≈Ç -->
            <div class="sources-container">
                <!-- Eventy -->
                <div class="source-section">
                    <div class="source-header">Eventy</div>
                    <div class="source-body" id="eventsContainer">
                        <div class="loading">Wybierz datƒô i lokal, nastƒôpnie kliknij Szukaj</div>
                    </div>
                </div>
                
                <!-- Grupy -->
                <div class="source-section">
                    <div class="source-header">Grupy</div>
                    <div class="source-body" id="groupsContainer">
                        <div class="loading">Wybierz datƒô i lokal, nastƒôpnie kliknij Szukaj</div>
                    </div>
                </div>
                
                <!-- Karty Menu -->
                <div class="source-section">
                    <div class="source-header">Karty Menu</div>
                    <div class="source-body" id="menuCardsContainer">
                        <div class="loading">Wybierz datƒô i lokal, nastƒôpnie kliknij Szukaj</div>
                    </div>
                </div>
            </div>
            
            <!-- Akcje -->
            <div class="actions-bar">
                <div class="pdf-dropdown">
                    <button class="btn btn-success" onclick="togglePdfMenu()">
                        üìã Generuj listƒô zakup√≥w
                    </button>
                    <div class="pdf-menu" id="pdfMenu">
                        <button onclick="generateShoppingList('zamowienie')">Zam√≥wienie</button>
                        <button onclick="generateShoppingList('rozpiska_ogolna')">Rozpiska og√≥lna</button>
                        <button onclick="generateShoppingList('rozpiska_produkcyjna')">Rozpiska produkcyjna</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== ZMIENNE GLOBALNE ==========
        let sourcesData = {
            events: [],
            groups: [],
            menu_cards: []
        };
        
        let selectedSources = {
            events: {}, // {event_id: [day_ids]}
            groups: {}, // {group_id: [dates]}
            menu_cards: {} // {card_id: {dish_id: amount}}
        };
        
        // ========== INIT ==========
        window.addEventListener('DOMContentLoaded', () => {
            // Ustaw domy≈õlnƒÖ datƒô (dzi≈õ + 7 dni)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('filterDateTo').value = nextWeek.toISOString().split('T')[0];
        });
        
        // ========== ≈ÅADOWANIE ≈πR√ìDE≈Å ==========
        async function loadSources() {
            const dateTo = document.getElementById('filterDateTo').value;
            const lokal = document.getElementById('filterLokal').value;
            
            if (!dateTo) {
                alert('Wybierz datƒô');
                return;
            }
            
            try {
                // Poka≈º loading
                document.getElementById('eventsContainer').innerHTML = '<div class="loading">≈Åadowanie...</div>';
                document.getElementById('groupsContainer').innerHTML = '<div class="loading">≈Åadowanie...</div>';
                document.getElementById('menuCardsContainer').innerHTML = '<div class="loading">≈Åadowanie...</div>';
                
                const response = await fetch(`/api/shopping/sources?date_to=${dateTo}&lokal=${lokal}`);
                if (!response.ok) throw new Error('B≈ÇƒÖd ≈Çadowania ≈∫r√≥de≈Ç');
                
                sourcesData = await response.json();
                
                renderEvents();
                renderGroups();
                renderMenuCards();
                
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd ≈Çadowania ≈∫r√≥de≈Ç');
            }
        }
        
        // ========== RENDEROWANIE EVENT√ìW ==========
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            
            if (sourcesData.events.length === 0) {
                container.innerHTML = '<div class="empty-state">Brak event√≥w w wybranym okresie</div>';
                return;
            }
            
            container.innerHTML = sourcesData.events.map(event => `
                <div class="source-item" id="event-${event.id}">
                    <div class="source-checkbox">
                        <input type="checkbox" id="event-check-${event.id}" 
                               onchange="toggleEventSelection(${event.id})">
                        <label for="event-check-${event.id}">${event.nazwa}</label>
                    </div>
                    <div class="source-meta">
                        üìç ${event.lokal || 'Brak lokalu'} ‚Ä¢ 
                        üìÖ ${formatDate(event.data_rozpoczecia)} - ${formatDate(event.data_zakonczenia)}
                    </div>
                    <div class="days-list" id="event-days-${event.id}">
                        ${event.days.map(day => `
                            <div class="day-item">
                                <input type="checkbox" id="event-day-${event.id}-${day.id}"
                                       onchange="toggleEventDay(${event.id}, ${day.id})">
                                <label for="event-day-${event.id}-${day.id}">
                                    Dzie≈Ñ ${day.kolejnosc + 1} - ${formatDate(day.data)} (${getDayName(day.data)})
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function toggleEventSelection(eventId) {
            const checkbox = document.getElementById(`event-check-${eventId}`);
            const daysList = document.getElementById(`event-days-${eventId}`);
            const item = document.getElementById(`event-${eventId}`);
            
            if (checkbox.checked) {
                daysList.classList.add('visible');
                item.classList.add('selected');
                selectedSources.events[eventId] = [];
            } else {
                daysList.classList.remove('visible');
                item.classList.remove('selected');
                delete selectedSources.events[eventId];
                // Odznacz wszystkie dni
                const event = sourcesData.events.find(e => e.id === eventId);
                event.days.forEach(day => {
                    document.getElementById(`event-day-${eventId}-${day.id}`).checked = false;
                });
            }
        }
        
        function toggleEventDay(eventId, dayId) {
            const checkbox = document.getElementById(`event-day-${eventId}-${dayId}`);
            
            if (!selectedSources.events[eventId]) {
                selectedSources.events[eventId] = [];
            }
            
            if (checkbox.checked) {
                if (!selectedSources.events[eventId].includes(dayId)) {
                    selectedSources.events[eventId].push(dayId);
                }
            } else {
                selectedSources.events[eventId] = selectedSources.events[eventId].filter(id => id !== dayId);
            }
        }
        
        // ========== RENDEROWANIE GRUP ==========
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            
            if (sourcesData.groups.length === 0) {
                container.innerHTML = '<div class="empty-state">Brak grup w wybranym okresie</div>';
                return;
            }
            
            container.innerHTML = sourcesData.groups.map(group => `
                <div class="source-item" id="group-${group.id}">
                    <div class="source-checkbox">
                        <input type="checkbox" id="group-check-${group.id}" 
                               onchange="toggleGroupSelection(${group.id})">
                        <label for="group-check-${group.id}">${group.nazwa}</label>
                    </div>
                    <div class="source-meta">
                        üìç ${group.lokal || 'Brak lokalu'} ‚Ä¢ 
                        üìÖ ${formatDate(group.data_pierwszy_posilek)} - ${formatDate(group.data_ostatni_posilek)}
                    </div>
                    <div class="days-list" id="group-days-${group.id}">
                        ${group.days.map((day, idx) => `
                            <div class="day-item">
                                <input type="checkbox" id="group-day-${group.id}-${idx}"
                                       data-date="${day.date}"
                                       onchange="toggleGroupDay(${group.id}, '${day.date}')">
                                <label for="group-day-${group.id}-${idx}">
                                    Dzie≈Ñ ${day.day_number} - ${formatDate(day.date)} (${getDayName(day.date)})
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function toggleGroupSelection(groupId) {
            const checkbox = document.getElementById(`group-check-${groupId}`);
            const daysList = document.getElementById(`group-days-${groupId}`);
            const item = document.getElementById(`group-${groupId}`);
            
            if (checkbox.checked) {
                daysList.classList.add('visible');
                item.classList.add('selected');
                selectedSources.groups[groupId] = [];
            } else {
                daysList.classList.remove('visible');
                item.classList.remove('selected');
                delete selectedSources.groups[groupId];
                // Odznacz wszystkie dni
                const group = sourcesData.groups.find(g => g.id === groupId);
                group.days.forEach((day, idx) => {
                    document.getElementById(`group-day-${groupId}-${idx}`).checked = false;
                });
            }
        }
        
        function toggleGroupDay(groupId, date) {
            const checkbox = document.querySelector(`#group-day-${groupId}-[data-date="${date}"]`);
            
            if (!selectedSources.groups[groupId]) {
                selectedSources.groups[groupId] = [];
            }
            
            if (checkbox && checkbox.checked) {
                if (!selectedSources.groups[groupId].includes(date)) {
                    selectedSources.groups[groupId].push(date);
                }
            } else {
                selectedSources.groups[groupId] = selectedSources.groups[groupId].filter(d => d !== date);
            }
        }
        
        // ========== RENDEROWANIE KART MENU ==========
        async function renderMenuCards() {
            const container = document.getElementById('menuCardsContainer');
            
            if (sourcesData.menu_cards.length === 0) {
                container.innerHTML = '<div class="empty-state">Brak aktywnych kart menu</div>';
                return;
            }
            
            container.innerHTML = '<div class="loading">≈Åadowanie da≈Ñ...</div>';
            
            // Dla ka≈ºdej karty pobierz dania
            for (const card of sourcesData.menu_cards) {
                const response = await fetch(`/api/menu-cards/${card.id}/sections`);
                const sections = await response.json();
                card.dishes = [];
                sections.forEach(section => {
                    card.dishes.push(...(section.dishes || []));
                });
            }
            
            container.innerHTML = sourcesData.menu_cards.map(card => `
                <div class="source-item" id="menu-${card.id}">
                    <div class="source-checkbox">
                        <input type="checkbox" id="menu-check-${card.id}" 
                               onchange="toggleMenuSelection(${card.id})">
                        <label for="menu-check-${card.id}">${card.nazwa}</label>
                    </div>
                    <div class="source-meta">
                        üìç ${card.lokal} ‚Ä¢ 
                        üè∑Ô∏è ${card.status}
                    </div>
                    <div class="manual-amounts" id="menu-amounts-${card.id}">
                        ${card.dishes.map(dish => `
                            <div class="amount-item">
                                <label>${dish.dishes.nazwa_karta || dish.dishes.nazwa}</label>
                                <input type="number" min="0" step="1" placeholder="0" 
                                       id="menu-${card.id}-dish-${dish.dish_id}"
                                       onchange="updateMenuAmount(${card.id}, ${dish.dish_id}, this.value)">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        async function toggleMenuSelection(cardId) {
            const checkbox = document.getElementById(`menu-check-${cardId}`);
            const amountsList = document.getElementById(`menu-amounts-${cardId}`);
            const item = document.getElementById(`menu-${cardId}`);
            
            if (checkbox.checked) {
                amountsList.classList.add('visible');
                item.classList.add('selected');
                selectedSources.menu_cards[cardId] = {};
                
                amountsList.innerHTML = '<div class="loading">≈Åadowanie sk≈Çadnik√≥w...</div>';
                
                try {
                    const sectionsRes = await fetch(`/api/menu-cards/${cardId}/sections`);
                    const sections = await sectionsRes.json();
                    
                    const ingredientsMap = {};
                    
                    for (const section of sections) {
                        for (const sectionDish of section.dishes || []) {
                            const compRes = await fetch(`/api/dishes/${sectionDish.dish_id}/components`);
                            const components = await compRes.json();
                            
                            for (const comp of components) {
                                const ingRes = await fetch(`/api/recipes/${comp.recipe_id}`);
                                const recipe = await ingRes.json();
                                
                                for (const ing of recipe.skladniki || []) {
                                    const ingId = ing.ingredient_id;
                                    console.log('Processing ingredient:', ing.ingredients.nazwa, 'ID:', ingId);
                                    if (!ingredientsMap[ingId]) {
                                        ingredientsMap[ingId] = {
                                            id: ingId,
                                            nazwa: ing.ingredients.nazwa,
                                            jm: ing.jm
                                        };
                                        console.log('Added to map:', ing.ingredients.nazwa);
                                    } else {
                                        console.log('Already in map:', ing.ingredients.nazwa);
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log('Final ingredientsMap:', ingredientsMap);
                    console.log('Keys in map:', Object.keys(ingredientsMap));

                    const ingredients = Object.values(ingredientsMap).sort((a, b) => a.nazwa.localeCompare(b.nazwa, 'pl'));
                    
                    if (ingredients.length === 0) {
                        amountsList.innerHTML = '<div class="empty-state">Brak sk≈Çadnik√≥w w tej karcie</div>';
                        return;
                    }
                    
                    amountsList.innerHTML = ingredients.map(ing => `
                        <div class="amount-item">
                            <label>${ing.nazwa} (${ing.jm})</label>
                            <input type="number" min="0" step="0.001" placeholder="0" 
                                   id="menu-${cardId}-ing-${ing.id}"
                                   data-jm="${ing.jm}"
                                   onchange="updateMenuIngredientAmount(${cardId}, ${ing.id}, this.value, '${ing.jm}')">
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error('Error loading ingredients:', error);
                    amountsList.innerHTML = '<div class="empty-state">B≈ÇƒÖd ≈Çadowania sk≈Çadnik√≥w</div>';
                }
                
            } else {
                amountsList.classList.remove('visible');
                item.classList.remove('selected');
                delete selectedSources.menu_cards[cardId];
                amountsList.innerHTML = '';
            }
        }
        
        function updateMenuAmount(cardId, dishId, amount) {
            if (!selectedSources.menu_cards[cardId]) {
                selectedSources.menu_cards[cardId] = {};
            }
            
            const parsedAmount = parseInt(amount);
            if (parsedAmount > 0) {
                selectedSources.menu_cards[cardId][dishId] = parsedAmount;
            } else {
                delete selectedSources.menu_cards[cardId][dishId];
            }
        }
        
        // ========== GENEROWANIE LISTY ==========
        function togglePdfMenu() {
            const menu = document.getElementById('pdfMenu');
            menu.classList.toggle('active');
            
            if (menu.classList.contains('active')) {
                setTimeout(() => {
                    document.addEventListener('click', closePdfMenuOnOutsideClick);
                }, 0);
            }
        }
        
        function closePdfMenuOnOutsideClick(e) {
            const menu = document.getElementById('pdfMenu');
            if (!e.target.closest('.pdf-dropdown')) {
                menu.classList.remove('active');
                document.removeEventListener('click', closePdfMenuOnOutsideClick);
            }
        }
        
        async function generateShoppingList(typ) {
            const menu = document.getElementById('pdfMenu');
            menu.classList.remove('active');
            
            // Przygotuj ≈∫r√≥d≈Ça do wys≈Çania
            const sources = [];
            
            // Eventy
            for (const [eventId, dayIds] of Object.entries(selectedSources.events)) {
                if (dayIds.length > 0) {
                    const event = sourcesData.events.find(e => e.id == eventId);
                    sources.push({
                        type: 'event',
                        id: parseInt(eventId),
                        days: dayIds.map(dayId => {
                            const day = event.days.find(d => d.id == dayId);
                            return { day_id: dayId, date: day.data };
                        })
                    });
                }
            }
            
            // Grupy
            for (const [groupId, dates] of Object.entries(selectedSources.groups)) {
                if (dates.length > 0) {
                    sources.push({
                        type: 'group',
                        id: parseInt(groupId),
                        days: dates.map(date => ({ date }))
                    });
                }
            }
            
            // Karty menu
            for (const [cardId, amounts] of Object.entries(selectedSources.menu_cards)) {
                if (Object.keys(amounts).length > 0) {
                    sources.push({
                        type: 'menu_card',
                        id: parseInt(cardId),
                        manual_amounts: amounts
                    });
                }
            }
            
            if (sources.length === 0) {
                alert('Nie wybrano ≈ºadnych ≈∫r√≥de≈Ç');
                return;
            }
            
            try {
                // Wylicz sk≈Çadniki
                const response = await fetch('/api/shopping/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sources })
                });
                
                if (!response.ok) throw new Error('B≈ÇƒÖd wyliczania sk≈Çadnik√≥w');
                
                const ingredients = await response.json();
                
                if (ingredients.length === 0) {
                    alert('Brak sk≈Çadnik√≥w do wygenerowania');
                    return;
                }
                
                // Generuj PDF
                if (typ === 'zamowienie') {
                    generateZamowieniePDF(ingredients);
                } else if (typ === 'rozpiska_ogolna') {
                    generateRozpiskaOgolnaPDF(ingredients);
                } else if (typ === 'rozpiska_produkcyjna') {
                    generateRozpiskaProdukcyjnaPDF(ingredients);
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('B≈ÇƒÖd generowania listy zakup√≥w');
            }
        }
        
        // ========== GENEROWANIE PDF - ZAM√ìWIENIE ==========
        function generateZamowieniePDF(ingredients) {
            const content = [
                { text: 'LISTA ZAKUP√ìW - ZAM√ìWIENIE', style: 'header', margin: [0, 0, 0, 20] },
                { text: `Data: ${new Date().toLocaleDateString('pl-PL')}`, style: 'date', margin: [0, 0, 0, 30] },
                {
                    table: {
                        headerRows: 1,
                        widths: ['*', 80, 60],
                        body: [
                            [
                                { text: 'Sk≈Çadnik', style: 'tableHeader' },
                                { text: 'Ilo≈õƒá', style: 'tableHeader', alignment: 'right' },
                                { text: 'JM', style: 'tableHeader' }
                            ],
                            ...ingredients
                                .sort((a, b) => a.nazwa.localeCompare(b.nazwa))
                                .map(ing => [
                                    ing.nazwa,
                                    { text: ing.ilosc.toFixed(3), alignment: 'right' },
                                    ing.jm
                                ])
                        ]
                    }
                }
            ];
            
            const docDefinition = {
                content,
                styles: {
                    header: { fontSize: 18, bold: true, color: '#0A1F44' },
                    date: { fontSize: 11, color: '#666' },
                    tableHeader: { bold: true, fontSize: 11, color: '#0A1F44', fillColor: '#f0f0f0' }
                },
                pageMargins: [40, 40, 40, 40]
            };
            
            pdfMake.createPdf(docDefinition).download('zamowienie.pdf');
        }
        
        // ========== GENEROWANIE PDF - ROZPISKA OG√ìLNA ==========
        function generateRozpiskaOgolnaPDF(ingredients) {
            const content = [
                { text: 'LISTA ZAKUP√ìW - ROZPISKA OG√ìLNA', style: 'header', margin: [0, 0, 0, 20] },
                { text: `Data: ${new Date().toLocaleDateString('pl-PL')}`, style: 'date', margin: [0, 0, 0, 30] }
            ];
            
            ingredients.sort((a, b) => a.nazwa.localeCompare(b.nazwa)).forEach(ing => {
                content.push({
                    text: `${ing.nazwa} - ${ing.ilosc.toFixed(3)} ${ing.jm}`,
                    style: 'ingredient',
                    margin: [0, 10, 0, 5]
                });
                
                // ≈πr√≥d≈Ça
                const sources = ing.breakdown.sources || [];
                sources.forEach(source => {
                    content.push({
                        text: `‚Ä¢ ${source.amount.toFixed(3)} ${ing.jm} - ${source.name}`,
                        style: 'source',
                        margin: [20, 2, 0, 0]
                    });
                });
            });
            
            const docDefinition = {
                content,
                styles: {
                    header: { fontSize: 18, bold: true, color: '#0A1F44' },
                    date: { fontSize: 11, color: '#666' },
                    ingredient: { fontSize: 13, bold: true, color: '#0A1F44' },
                    source: { fontSize: 10, color: '#333' }
                },
                pageMargins: [40, 40, 40, 40]
            };
            
            pdfMake.createPdf(docDefinition).download('rozpiska_ogolna.pdf');
        }
        
        // ========== GENEROWANIE PDF - ROZPISKA PRODUKCYJNA ==========
        function generateRozpiskaProdukcyjnaPDF(ingredients) {
            const content = [
                { text: 'LISTA ZAKUP√ìW - ROZPISKA PRODUKCYJNA', style: 'header', margin: [0, 0, 0, 20] },
                { text: `Data: ${new Date().toLocaleDateString('pl-PL')}`, style: 'date', margin: [0, 0, 0, 30] }
            ];
            
            ingredients.sort((a, b) => a.nazwa.localeCompare(b.nazwa)).forEach(ing => {
                content.push({
                    text: `${ing.nazwa} - ${ing.ilosc.toFixed(3)} ${ing.jm}`,
                    style: 'ingredient',
                    margin: [0, 10, 0, 5]
                });
                
                // ≈πr√≥d≈Ça ze szczeg√≥≈Çami da≈Ñ
                const sources = ing.breakdown.sources || [];
                sources.forEach(source => {
                    content.push({
                        text: `‚Ä¢ ${source.amount.toFixed(3)} ${ing.jm} - ${source.name}`,
                        style: 'source',
                        margin: [20, 2, 0, 0]
                    });
                    
                    // Dania (tylko dla event i group, nie dla menu_card)
                    if (source.dishes && source.dishes.length > 0) {
                        source.dishes.forEach(dish => {
                            content.push({
                                text: `  - ${dish.amount.toFixed(3)} ${ing.jm}: ${dish.name}`,
                                style: 'dish',
                                margin: [40, 0, 0, 0]
                            });
                        });
                    }
                });
            });
            
            const docDefinition = {
                content,
                styles: {
                    header: { fontSize: 18, bold: true, color: '#0A1F44' },
                    date: { fontSize: 11, color: '#666' },
                    ingredient: { fontSize: 13, bold: true, color: '#0A1F44' },
                    source: { fontSize: 10, color: '#333' },
                    dish: { fontSize: 9, color: '#666', italics: true }
                },
                pageMargins: [40, 40, 40, 40]
            };
            
            pdfMake.createPdf(docDefinition).download('rozpiska_produkcyjna.pdf');
        }
        
        // ========== HELPERS ==========
        function formatDate(dateStr) {
            if (!dateStr) return '‚Äî';
            return new Date(dateStr).toLocaleDateString('pl-PL');
        }
        
        function getDayName(dateStr) {
            const days = ['niedziela', 'poniedzia≈Çek', 'wtorek', '≈õroda', 'czwartek', 'piƒÖtek', 'sobota'];
            return days[new Date(dateStr).getDay()];
        }
    </script>
</body>
</html>
